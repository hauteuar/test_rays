<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Checkout</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/mobile.css">
  <link rel="stylesheet" href="css/tab.css">
  <link rel="shortcut icon" href="images/1.png" />

  <!-- Include jQuery and Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <script src="components/sidebar.js" type="text/javascript" defer></script>
  <script src="components/topnav.js" type="text/javascript" defer></script>
</head>

<body>
  <div class="container-scroller">
    <div class="container-fluid page-body-wrapper">
      <sidebar-component data-page="checkout"></sidebar-component>
      <topnav-component></topnav-component>
      <div class="course-main billing">
        <div class="row justify-content-between">
          <div class="mb-3 mt-2 heading">
            <h4 style="font-weight: 650;margin-left: 0.7rem;">Checkout</h4>
          </div>
        </div>

        <div class="checkout-container">
          <div id="cart-items"></div>
          <div class="checkout-summary">
            <h5>Total Amount: $<span id="total-amount">0</span></h5>
            <button id="checkout-button" class="hwzthat-btn">Proceed to Payment</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  
  <!-- Payment Iframe Modal -->
  <div class="modal fade" id="paymentIframeModal" tabindex="-1" role="dialog" aria-labelledby="paymentIframeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="paymentIframeModalLabel">Complete Payment</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <iframe id="payment-iframe" src="" width="100%" height="600px" frameborder="0"></iframe>
        </div>
      </div>
    </div>
  </div>
    <script src="https://js.stripe.com/v3/"></script>
    <script>
      let uniqueCode = localStorage.getItem('uniqueCode');
      //console.log(uniqueCode);
      if (!uniqueCode) {
        uniqueCode = "5e2c5922-4311-40cd-875a-9a4d73b47f71"; // Replace with the unique code for the connected account
      }
      //console.log(uniqueCode);
    
      let sports = [];
      let allCourts = [];
    
      async function fetchSportsAndCourts() {
        const organizationId = localStorage.getItem('organizationId'); // Get organizationId from localStorage
    
        try {
          const sportsResponse = await fetch('/api/sport/sports', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'organizationId': organizationId // Add organizationId to headers
            }
          });
    
          const courtsResponse = await fetch('/api/sport/courts', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'organizationId': organizationId // Add organizationId to headers
            }
          });
    
          sports = await sportsResponse.json();
          allCourts = await courtsResponse.json();
    
          // After fetching the data, load the cart items
          await loadCartItems();
        } catch (error) {
          console.error('Error fetching sports or courts:', error);
        }
      }
    
      async function loadCartItems() {
    const userId = localStorage.getItem('userId');
    const organizationId = localStorage.getItem('organizationId'); // Get organizationId from localStorage
    const cartItemsContainer = document.getElementById('cart-items');
    const role = localStorage.getItem('role');
    cartItemsContainer.innerHTML = '';

    let totalAmount = 0;
    let response;

    try {
        console.log(role);
        if (role === 'org_admin') {
            response = await fetch(`/api/cart/org/${organizationId}`, {
                headers: {
                    'Content-Type': 'application/json',
                    'organizationId': organizationId
                }
            });
        } else {
            response = await fetch(`/api/cart/${userId}`, {
                headers: {
                    'Content-Type': 'application/json',
                    'organizationId': organizationId
                }
            });
        }

        if (!response.ok) {
            console.error('Failed to load cart items');
            return;
        }
        
        const cart = await response.json();
        console.log(cart);

        // Assuming cart is an array of cartItems
        const cartItems = Array.isArray(cart) ? cart : cart.items;

        cartItems.forEach(cartItem => {
            console.log('cartItem:', cartItem);  // Log the entire cartItem to inspect its structure

            // Update the total amount
            totalAmount += cartItem.price * cartItem.quantity;

            const sport = sports.find(s => String(s._id) === String(cartItem.sportId));
            const court = allCourts.find(c => String(c._id) === String(cartItem.courtId));

            const itemElement = document.createElement('div');
            itemElement.classList.add('cart-item');

            // Check if transactionId starts with "bki"
            const showSportAndCourt = cartItem.paymentId.transactionId.startsWith('bki');

            itemElement.innerHTML = `
                <div class="item-details">
                    <p>Type: ${cartItem.itemType}</p>
                    ${showSportAndCourt ? `<p>Sport: ${sport ? sport.name : 'Unknown'}</p>` : ''}
                    ${showSportAndCourt ? `<p>Court: ${court ? court.name : 'Unknown'}</p>` : ''}
                    <p>User ID: ${cartItem.userId}</p>
                    <p>Price: $${cartItem.price.toFixed(2)}</p>
                    <p>Quantity: 
                        <button class="quantity-btn" onclick="updateQuantity('${cartItem._id}', -1)">-</button>
                        ${cartItem.quantity}
                        <button class="quantity-btn" onclick="updateQuantity('${cartItem._id}', 1)">+</button>
                    </p>
                    <button class="remove-btn" onclick="removeCartItem('${cartItem.paymentId._id}')">Remove</button>
                </div>
            `;
            cartItemsContainer.appendChild(itemElement);
        });

        document.getElementById('total-amount').textContent = totalAmount.toFixed(2);

    } catch (error) {
        console.error('Error loading cart items:', error);
    }
}


    
      async function updateQuantity(index, change) {
        const userId = localStorage.getItem('userId');
        const organizationId = localStorage.getItem('organizationId'); // Get organizationId from localStorage
    
        try {
          const response = await fetch(`/api/cart/${userId}`, {
            headers: {
              'Content-Type': 'application/json',
              'organizationId': organizationId
            }
          });
    
          if (!response.ok) {
            console.error('Failed to update quantity');
            return;
          }
    
          const cart = await response.json();
          const item = cart.items[index];
    
          if (item.quantity + change > 0) {
            item.quantity += change;
            cart.totalAmount += change * item.price; // Update the total amount
    
            // Update the cart in the database
            await fetch(`/api/cart/${userId}/update-quantity`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'organizationId': organizationId
              },
              body: JSON.stringify({ itemId: item.itemId, quantity: item.quantity })
            });
    
            loadCartItems(); // Reload the cart items
            updateCartIcon(); // Update the cart icon
          }
        } catch (error) {
          console.error('Error updating quantity:', error);
        }
      }
    
      async function removeCartItem(paymentId) {
        const userId = localStorage.getItem('userId');
        const organizationId = localStorage.getItem('organizationId'); // Get organizationId from localStorage
    
        try {
          // Remove the item from the cart in the database
          await fetch('/api/cart/remove-item', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'organizationId': organizationId
            },
            body: JSON.stringify({ userId, paymentId })
          });
    
          loadCartItems(); // Reload the cart items
          updateCartIcon(); // Update the cart icon
        } catch (error) {
          console.error('Error removing item from cart:', error);
        }
      }
    
      document.getElementById('checkout-button').addEventListener('click', async function () {
    const userId = localStorage.getItem('userId');
    const organizationId = localStorage.getItem('organizationId'); // Get organizationId from localStorage
    const role = localStorage.getItem('role');

    try {
        let response;
        if (role === 'org_admin') {
            response = await fetch(`/api/cart/org/${organizationId}`, {
                headers: {
                    'Content-Type': 'application/json',
                    'organizationId': organizationId
                }
            });
        } else {
            response = await fetch(`/api/cart/${userId}`, {
                headers: {
                    'Content-Type': 'application/json',
                    'organizationId': organizationId
                }
            });
        }

        if (!response.ok) {
            console.error('Failed to retrieve cart');
            return;
        }

        const cart = await response.json();
        console.log('cart:', cart);

        // Initialize an array to store all transaction IDs
        let transactionIds = [];

        // Loop through each item in the cart's items array and collect transaction IDs
        if (cart && Array.isArray(cart.items)) {
            cart.items.forEach(item => {
                if (item.paymentId && item.paymentId.transactionId) {
                    transactionIds.push(String(item.paymentId.transactionId));
                }
            });
        }

        // Convert the transactionIds array into a comma-separated string
        const transactionIdsString = transactionIds.join(',');

        console.log('transactionIds', transactionIdsString);
        const successUrl = `http://localhost:5000/success?transactionIds=${transactionIdsString}`;
        const cancelUrl = `http://localhost:5000/cancel?transactionIds=${transactionIdsString}`;
        const totalAmount = parseFloat(document.getElementById('total-amount').textContent);

        const paymentDetails = {
            clientId: "HWZTHAT202401",
            transactionId: transactionIdsString,  // Pass all transaction IDs
            uniqueCode: uniqueCode,
            callbackUrl: "http://localhost:5000/checkout.html",
            successUrl,
            cancelUrl,
            productName: "Combined Purchase",
            amount: totalAmount,
            currency: "usd",
            applicationFeePercent: 5,
            isSubscription: false,
            customerId: "cus_Qeh75XVzBvXcPG",
            recurringIntervalType: "day",
            recurringIntervalCount: 1,
        };

        const paymentResponse = await fetch('https://api-payments.rayssportsnetwork.com/checkout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(paymentDetails),
        });

        const result = await paymentResponse.json();
        if (result.url) {
            // Redirect to the Stripe payment page
            window.location.href = result.url;
        } else {
            alert('Payment initiation failed.');
        }
    } catch (error) {
        console.error('Error processing payment:', error);
        alert('Failed to initiate payment.');
    }
});


      
      fetchSportsAndCourts(); // Fetch the data and then load the cart items
    </script>
    
</body>

</html>
