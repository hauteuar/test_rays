<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Checkout</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/mobile.css">
  <link rel="stylesheet" href="css/tab.css">
  <link rel="shortcut icon" href="images/1.png" />

  <!-- Include jQuery and Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <script src="components/sidebar.js" type="text/javascript" defer></script>
  <script src="components/topnav.js" type="text/javascript" defer></script>

  <style>
    .cart-item {
      background-color: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .item-details {
      display: flex;
      flex-direction: column;
    }

    .item-price {
      text-align: right;
      font-weight: bold;
      font-size: 18px;
    }

    .item-quantity {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    }

    .quantity-btn {
      background-color: #e0e0e0;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .remove-btn img {
      width: 20px;
      cursor: pointer;
    }

    .hwzthat-btn {
      background-color: #007bff;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-align: center;
    }

    .hwzthat-btn:disabled {
      background-color: #c0c0c0;
    }
  </style>
</head>

<body>
  <div class="container-scroller">
    <div class="container-fluid page-body-wrapper">
      <sidebar-component data-page="checkout"></sidebar-component>
      <topnav-component></topnav-component>
      <div class="course-main billing">
        <div class="row justify-content-between">
          <div class="mb-3 mt-2 heading">
            <h4 style="font-weight: 650;margin-left: 0.7rem;">Checkout</h4>
          </div>
        </div>

        <div class="checkout-container">
          <div class="row">
            <!-- Cart Items -->
            <div class="col-md-8">
              <div id="cart-items"></div>
              <button id="add-item-button" class="hwzthat-btn">Add Item</button>
            </div>

            <!-- Order Summary -->
            <div class="col-md-4">
              <div class="checkout-summary">
                <h5>Order Summary</h5>
                <p>Subtotal: $<span id="subtotal-amount">0</span></p>
                <p>Total Discount: $<span id="discount-amount">0</span></p>
                <h4>Estimated Total: $<span id="total-amount">0</span></h4>
                <button id="add-discount-button" class="hwzthat-btn" style="display: none;">Add Discount Code</button>
                <button id="checkout-button" class="hwzthat-btn">Checkout Now</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Payment Iframe Modal -->
  <div class="modal fade" id="paymentIframeModal" tabindex="-1" role="dialog" aria-labelledby="paymentIframeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="paymentIframeModalLabel">Complete Payment</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <iframe id="payment-iframe" src="" width="100%" height="600px" frameborder="0"></iframe>
        </div>
      </div>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script src="js/off-canvas.js"></script>
  <script src="js/template.js"></script>
 
  <script src="https://js.stripe.com/v3/"></script>
  <script>
    let uniqueCode = localStorage.getItem('uniqueCode');
    if (!uniqueCode) {
      uniqueCode = "5e2c5922-4311-40cd-875a-9a4d73b47f71"; // Replace with the unique code for the connected account
    }

    let sports = [];
    let allCourts = [];

    async function fetchSportsAndCourts() {
      const organizationId = localStorage.getItem('organizationId');

      try {
        const sportsResponse = await fetch('/api/sport/sports', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'organizationId': organizationId
          }
        });

        const courtsResponse = await fetch('/api/sport/courts', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'organizationId': organizationId
          }
        });

        sports = await sportsResponse.json();
        allCourts = await courtsResponse.json();

        // After fetching the data, load the cart items
        await loadCartItems();
      } catch (error) {
        console.error('Error fetching sports or courts:', error);
      }
    }

    async function loadCartItems() {
      const userId = localStorage.getItem('userId');
      const organizationId = localStorage.getItem('organizationId');
      const cartItemsContainer = document.getElementById('cart-items');
      const role = localStorage.getItem('role');
      cartItemsContainer.innerHTML = '';

      let totalAmount = 0;
      let response;

      try {
        if (role === 'org_admin') {
          response = await fetch(`/api/cart/org/${organizationId}`, {
            headers: {
              'Content-Type': 'application/json',
              'organizationId': organizationId
            }
          });
        } else {
          response = await fetch(`/api/cart/${userId}`, {
            headers: {
              'Content-Type': 'application/json',
              'organizationId': organizationId
            }
          });
        }

        if (!response.ok) {
          console.error('Failed to load cart items');
          return;
        }

        const cart = await response.json();

        if (!Array.isArray(cart)) {
          console.error('Unexpected cart data structure:', cart);
          return;
        }

        cart.forEach(cartObject => {
          const cartItems = cartObject.items;

          cartItems.forEach(cartItem => {
            if (!cartItem || !cartItem.paymentId || !cartItem.paymentId._id) {
              console.warn('Skipping cart item due to missing data:', cartItem);
              return;
            }

            totalAmount += cartItem.price * cartItem.quantity;

            const sport = sports.find(s => String(s._id) === String(cartItem.sportId));
            const court = allCourts.find(c => String(c._id) === String(cartItem.courtId));

            const itemElement = document.createElement('div');
            itemElement.classList.add('cart-item');
            itemElement.innerHTML = `
              <div class="item-details">
                <p><strong>${cartItem.itemName || 'Unknown Item'}</strong></p>
                <p>Batch: ${cartItem.batchTime || 'Unknown Time'}</p>
                <p>Sport: ${sport ? sport.name : 'Unknown Sport'}, Court: ${court ? court.name : 'Unknown Court'}</p>
              </div>
              <div class="item-price">
                $${cartItem.price}
                <div class="item-quantity">
                  <button class="quantity-btn" onclick="updateQuantity('${cartItem.paymentId._id}', -1)">-</button>
                  <span>${cartItem.quantity}</span>
                  <button class="quantity-btn" onclick="updateQuantity('${cartItem.paymentId._id}', 1)">+</button>
                </div>
                <button class="remove-btn" onclick="removeCartItem('${cartItem.paymentId._id}')">
                  <img src="images/trash-icon.png" alt="Remove Item">
                </button>
              </div>
            `;
            cartItemsContainer.appendChild(itemElement);
          });
        });

        document.getElementById('subtotal-amount').textContent = totalAmount.toFixed(2);

      } catch (error) {
        console.error('Error loading cart items:', error);
      }
    }

    async function updateQuantity(itemId, change) {
      // Logic to update quantity
    }

    async function removeCartItem(paymentId) {
      const userId = localStorage.getItem('userId');
      const organizationId = localStorage.getItem('organizationId');

      try {
        await fetch('/api/cart/remove-item', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'organizationId': organizationId
          },
          body: JSON.stringify({ userId, paymentId })
        });

        loadCartItems();
      } catch (error) {
        console.error('Error removing item from cart:', error);
      }
    }

    document.getElementById('checkout-button').addEventListener('click', async function () {
      const userId = localStorage.getItem('userId');
      const organizationId = localStorage.getItem('organizationId');
      const role = localStorage.getItem('role');

      try {
        let response;
        if (role === 'org_admin') {
          response = await fetch(`/api/cart/org/${organizationId}`, {
            headers: {
              'Content-Type': 'application/json',
              'organizationId': organizationId
            }
          });
        } else {
          response = await fetch(`/api/cart/${userId}`, {
            headers: {
              'Content-Type': 'application/json',
              'organizationId': organizationId
            }
          });
        }

        if (!response.ok) {
          console.error('Failed to retrieve cart');
          return;
        }

        const cart = await response.json();
        console.log('cart:', cart);

        let transactionIds = [];

        if (cart && Array.isArray(cart.items)) {
          cart.items.forEach(item => {
            if (item.paymentId && item.paymentId.transactionId) {
              transactionIds.push(String(item.paymentId.transactionId));
            }
          });
        }

        const transactionIdsString = transactionIds.join(',');

        console.log('transactionIds', transactionIdsString);
        const successUrl = `http://localhost:5000/success?transactionIds=${transactionIdsString}`;
        const cancelUrl = `http://localhost:5000/cancel?transactionIds=${transactionIdsString}`;
        const totalAmount = parseFloat(document.getElementById('total-amount').textContent);

        const paymentDetails = {
          clientId: "HWZTHAT202401",
          transactionId: transactionIdsString,
          uniqueCode: uniqueCode,
          callbackUrl: "http://localhost:5000/checkout.html",
          successUrl,
          cancelUrl,
          productName: "Combined Purchase",
          amount: totalAmount,
          currency: "usd",
          applicationFeePercent: 5,
          isSubscription: false,
          customerId: "cus_Qeh75XVzBvXcPG",
          recurringIntervalType: "day",
          recurringIntervalCount: 1,
        };

        const paymentResponse = await fetch('https://api-payments.rayssportsnetwork.com/checkout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(paymentDetails),
        });

        const result = await paymentResponse.json();
        if (result.url) {
          window.location.href = result.url;
        } else {
          alert('Payment initiation failed.');
        }
      } catch (error) {
        console.error('Error processing payment:', error);
        alert('Failed to initiate payment.');
      }
    });

    fetchSportsAndCourts();
  </script>
</body>

</html>
