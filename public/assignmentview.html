<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Assignments</title>
  <link rel="stylesheet" href="css/style-coach.css">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/mobile.css">
  <link rel="stylesheet" href="css/tab.css">
  <link rel="shortcut icon" href="images/favicon.png" />
  <link rel="stylesheet" href="vendors/ti-icons/css/themify-icons.css">
  <script src="components/sidebar.js" type="text/javascript" defer></script>
  <script src="components/topnav.js" type="text/javascript" defer></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
  <div class="container-scroller">
    <topnav-component></topnav-component>
    <div class="container-fluid page-body-wrapper">
      <sidebar-component data-page="assignment"></sidebar-component>
      <div class="main-panel">
        <div class="flex-align second-header px-4 py-2" style="border-bottom: 1px solid #D9D8D8;min-height: 60px;gap:10px">
          <h4 class="m-0">Assignments</h4>
        </div>
        <div class="content-wrapper">
          <div class="hwzthat-tabs">
            <div class="tabs-to-dropdown">
              <div class="nav-wrapper mb-2">
                <ul class="nav nav-pills d-md-flex" id="pills-tab" role="tablist" style="width:auto;">
                  <li class="nav-item" role="presentation">
                    <a class="nav-link active" id="pills-assignments-tab" data-toggle="pill" href="#pills-assignments" role="tab" aria-controls="pills-assignments" aria-selected="true">Assignments</a>
                  </li>
                  <li class="nav-item" role="presentation">
                    <a class="nav-link" id="pills-structured-tab" data-toggle="pill" href="#pills-structured" role="tab" aria-controls="pills-structured" aria-selected="false">Create/Edit Assignment</a>
                  </li>
                  <li class="nav-item" role="presentation">
                    <a class="nav-link" id="pills-history-tab" data-toggle="pill" href="#pills-history" role="tab" aria-controls="pills-history" aria-selected="false">Assignment History</a>
                  </li>
                  <li class="nav-item" role="presentation">
                    <a class="nav-link" id="pills-status-tab" data-toggle="pill" href="#pills-status" role="tab" aria-controls="pills-status" aria-selected="false">Assignment Status</a>
                </li>              
                </ul>
              </div>
              <div class="tab-content" id="pills-tabContent">
                <!-- Assignments Tab -->
                <div class="tab-pane fade show active" id="pills-assignments" role="tabpanel" aria-labelledby="pills-assignments-tab">
                  <div class="row" style="margin-left: -5px;margin-right: -5px;">
                    <div class="col-lg-2 col-md-3 col-6 pr-md-0" style="padding:5px;">
                      <div class="top-search">
                        <input type="text" name="assignmentSearch" id="assignmentSearch" class="hwzthat-input w-100" placeholder="Search assignments">
                        <img src="images/search.png">
                      </div>
                    </div>
                    <div class="col-lg-2 col-md-3 col-6 pr-md-0 dropdown dropdown-lg" style="padding:5px;">
                      <button class="btn dropdown-toggle w-100 hwzthat-dropdown" type="button" id="dropdownStudent" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                        Select Student
                      </button>
                      <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownStudent">
                        <a class="dropdown-item" href="#">Student 1</a>
                        <a class="dropdown-item" href="#">Student 2</a>
                        <a class="dropdown-item" href="#">Student 3</a>
                        <!-- Populate dynamically -->
                      </div>
                    </div>
                  </div>
                  <div class="row mx-0 mt-2" id="assignmentsList">
                    <!-- Assignments will be dynamically loaded here -->
                  </div>
                </div>

                <!-- Create/Edit Assignment Tab -->
                <div class="tab-pane fade" id="pills-structured" role="tabpanel" aria-labelledby="pills-structured-tab">
                  <div class="row" style="margin-left: -5px;margin-right: -5px;">
                    <div class="col-lg-8 col-md-6 col-6 pr-md-0" style="padding:5px;text-align: end;">
                      <a href="assignment-create.html">
                        <button class="btn site-btn-success hoverbtn pr-3 pl-2" style="height: auto;color: white!important;min-height: 36px;">
                          <img src="images/add-success.png" style="margin-right: 7px;">New Assignment
                        </button>
                      </a>
                    </div>
                  </div>
                  <div class="row mx-0 mt-2" id="editAssignmentsList">
                    <!-- List of created assignments will be dynamically loaded here -->
                  </div>
                </div>
                <!---- Assignment Status -->
                <div class="tab-pane fade" id="pills-status" role="tabpanel" aria-labelledby="pills-status-tab">
                  <div class="row" id="assignmentStatusList">
                      <!-- Assignment status list will be dynamically loaded here -->
                  </div>
              </div>
              
                <!-- Assignment History Tab -->
                <div class="tab-pane fade" id="pills-history" role="tabpanel" aria-labelledby="pills-history-tab">
                  <div class="row m-0">
                    <div class="col-12 hwzthat-cards-col flex-align mb-2" style="color: #476277;font-size: 14px;">
                      <ul class="nav d-md-flex requests-tabs" id="pills-tab" role="tablist">
                        <li>
                          <a class="btn radio-tabs active px-2 btn2" id="allHistory">
                            <div class="radio-icon radio-icon2"><img src="images/radio-not-active2.png"></div>
                            <h6 style="color: black;">All</h6>
                          </a>
                        </li>
                        <li>
                          <a class="btn radio-tabs px-2 btn2" id="practiceHistory">
                            <div class="radio-icon radio-icon2"><img src="images/radio-not-active2.png"></div>
                            <h6 style="color: black;">Assignments</h6>
                          </a>
                        </li>
                      </ul>
                      <div>
                        <div class="row m-0" style="margin-left: -4px;margin-right: -4px;">
                          <div class="col-md-3 col-6 dropdown" style="padding:0 4px;">
                            <div class="top-search">
                              <input type="text" name="" class="hwzthat-input w-100" placeholder="Search">
                              <img src="images/search-green.png" style="padding: 0;">
                            </div>
                          </div>
                          <div class="col-md-3 col-6 dropdown" style="padding:0 4px;">
                            <button class="btn dropdown-toggle w-100 hwzthat-dropdown" type="button" id="dropdownCourse" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                              Select Course
                            </button>
                            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownCourse">
                              <!-- Populate dynamically -->
                            </div>
                          </div>
                          <div class="col-md-3 col-6 dropdown" style="padding:0 4px;">
                            <button class="btn dropdown-toggle w-100 hwzthat-dropdown" type="button" id="dropdownStudentHistory" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                              Select Student
                            </button>
                            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownStudentHistory">
                              <!-- Populate dynamically -->
                            </div>
                          </div>
                          <div class="col-md-3 col-6 dropdown" style="padding:0 4px;">
                            <button class="btn dropdown-toggle date-toggle green-icon w-100 hwzthat-dropdown calneder-icon-drop" type="button" id="dropdownDateHistory" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                              Select date
                            </button>
                            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownDateHistory">
                              <div class="px-3 py-2">
                                <h6>From Date</h6>
                                <hr>
                                <input type="date" class="w-100 hwzthat-input2">
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-12">
                      <div class="tab-pane fade show active" id="pills-allHistory" role="tabpanel" aria-labelledby="pills-allHistory-tab">
                        <div class="row assignment-table" id="assignmentHistoryList">
                          <!-- Assignment history will be dynamically loaded here -->
                        </div>
                        <div class="next-buttons" style="margin-top: 15px;">
                          <span><img src="images/chevron-left.png"></span>
                          <span><img src="images/chevron-left2.png"></span>
                          <span class="active-page">1</span>
                          <span>2</span>
                          <span><img src="images/chevron-right2.png"></span>
                          <span><img src="images/chevron-right.png"></span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              <!-- Modal for viewing submitted task -->
<div class="modal fade" id="viewSubmissionModal" tabindex="-1" role="dialog" aria-labelledby="viewSubmissionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewSubmissionModalLabel">View Submission</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <h4 id="modalTaskTitle">Task Title</h4>
        <p id="modalTaskDescription">Task Description</p>
        <div id="modalMediaContainer">
          <!-- Media content will be dynamically inserted here -->
        </div>
        <div id="modalSubmissionContent">
          <!-- Text submission will be dynamically inserted here -->
        </div>
      </div>
      <div class="modal-footer">
        <textarea id="returnComment" class="form-control" placeholder="Add comment for return" style="display:none;"></textarea>
        <button type="button" class="btn btn-secondary" id="returnTaskBtn" style="display:none;">Return Task</button>
        <button type="button" class="btn btn-primary" id="enterProgressReportBtn">Enter Progress Report</button>
      </div>
    </div>
  </div>
</div>

                <script type="text/javascript">
                  $(document).ready(function() {
                    const organizationId = localStorage.getItem('organizationId'); // Assuming org ID is stored in local storage
                    const coachId = localStorage.getItem('userId'); // Assuming coach ID is stored in local storage

                    // Fetch assignments for the coach
                    fetch(`/api/tasks/${coachId}/${organizationId}`)
                      .then(response => response.json())
                      .then(tasks => {
                        displayAssignments(tasks);
                        displayEditAssignments(tasks);
                        displayAssignmentStatus(tasks);
                      })
                      .catch(error => console.error('Error fetching tasks:', error));

                    // Search assignments
                    $('#assignmentSearch').on('input', function() {
                      const searchTerm = $(this).val().toLowerCase();
                      $('#assignmentsList .hwzthat-cards').each(function() {
                        const title = $(this).find('h4').text().toLowerCase();
                        $(this).toggle(title.includes(searchTerm));
                      });
                    });

                    // Display assignments in the Assignments tab
                    function displayAssignments(tasks) {
                      console.log(tasks);
                      const assignmentsList = $('#assignmentsList');
                      assignmentsList.empty();
                      tasks.forEach(task => {
                        const assignmentCard = `
                          <div class="col-md-4 hwzthat-cards-col">
                            <a href="assignment-detail.html?taskId=${task._id}">
                              <div class="card hwzthat-cards">
                                <div class="d-flex align-items-start justify-content-between">
                                  <div class="flex-align2 g2 mb-2">
                                    <h4 class="mb-0" style="font-size: 14px;">${task.title}</h4>
                                    <button class="btn btn-warning btn-sm" style="border-color:#C93232;background: #ffe5e5;color: #C93232;">${task.status}</button>
                                  </div>
                                  <div class="dropdown btn py-0 pr-0" style="margin-top:-5px;">
                                    <img src="images/dots2.png" data-toggle="dropdown" id="moreDropdown" style="height: 12px;padding-right: 0;">
                                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="moreDropdown">
                                      <div class="dropdown-item mb-2">
                                        <img src="images/list.png" height="10" class="mr-2">List
                                      </div>
                                      <div href="coach-assignment3.html?taskId=${task._id}" class="dropdown-item mb-2">
                                        <img src="images/edit.png" height="10" class="mr-2">Edit
                                      </div>
                                      <div class="dropdown-item">
                                        <img src="images/delete.png" height="10" class="mr-2">Delete
                                      </div>
                                    </div>
                                  </div>
                                </div>
                                <div class="d-flex align-items-center" style="gap:5px;">
                                  <h6>${new Date(task.createdAt).toDateString()}</h6>
                                </div>
                                <div class="flex-align g2 mt-2">
                                  <div class="d-flex align-items-center g2">
                                    <img src="images/user2.png" width="25">
                                    <h6 class="m-0">${task.assignedTo.map(student => student.firstName).join(', ')}</h6>
                                  </div>
                                  <div data-toggle="modal" data-target="#record_sessionModal">
                                    <img src="images/video.png" width="30">
                                  </div>
                                </div>
                              </div>
                            </a>
                          </div>
                        `;
                        assignmentsList.append(assignmentCard);
                      });
                    }

                    // Display assignments in the Create/Edit Assignment tab
                    function displayEditAssignments(tasks) {
                      const editAssignmentsList = $('#editAssignmentsList');
                      editAssignmentsList.empty();
                      tasks.forEach(task => {
                        const editAssignmentCard = `
                          <div class="col-md-4 hwzthat-cards-col">
                            <a href="coach-assignment3.html?taskId=${task._id}">
                              <div class="card hwzthat-cards">
                                <div class="d-flex align-items-start justify-content-between">
                                  <div class="flex-align2 g2 mb-2">
                                    <h4 class="mb-0" style="font-size: 14px;">${task.title}</h4>
                                  </div>
                                  <div class="dropdown btn py-0 pr-0" style="margin-top:-5px;">
                                    <img src="images/dots2.png" data-toggle="dropdown" id="moreDropdown" style="height: 12px;padding-right: 0;">
                                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="moreDropdown">
                                      <div class="dropdown-item mb-2">
                                        <img src="images/list.png" height="10" class="mr-2">List
                                      </div>
                                      <div href="coach-assignment3.html?taskId=${task._id}" class="dropdown-item mb-2">
                                        <img src="images/edit.png" height="10" class="mr-2">Edit
                                      </div>
                                      <div class="dropdown-item">
                                        <img src="images/delete.png" height="10" class="mr-2">Delete
                                      </div>
                                    </div>
                                  </div>
                                </div>
                                <div class="d-flex align-items-center" style="gap:5px;">
                                  <h6>${new Date(task.createdAt).toDateString()}</h6>
                                </div>
                                <div class="flex-align g2 mt-2">
                                  <div class="d-flex align-items-center g2">
                                    <img src="images/user2.png" width="25">
                                    <h6 class="m-0">${task.assignedTo.map(student => student.firstName).join(', ')}</h6>
                                  </div>
                                  <div data-toggle="modal" data-target="#record_sessionModal">
                                    <img src="images/video.png" width="30">
                                  </div>
                                </div>
                              </div>
                            </a>
                          </div>
                        `;
                        editAssignmentsList.append(editAssignmentCard);
                      });
                    }

                    // Fetch and display assignment history
                    function fetchAssignmentHistory() {
                      // Implement API call to fetch assignment history and update #assignmentHistoryList
                    }

                    $('#allHistory, #practiceHistory').on('click', fetchAssignmentHistory);
                  });
                  function displayAssignmentStatus(tasks) {
        const assignmentStatusList = $('#assignmentStatusList');
        assignmentStatusList.empty();
        console.log(tasks);
        tasks.forEach(task => {
    const submissionsHtml = task.submissions.map(submission => {
        // Find the student in the assignedTo array
        const student = task.assignedTo.find(student => student._id.toString() === submission.studentId.toString());

        // Check if the student exists in the assignedTo array
        if (!student) {
            return `<p><strong>Student not found</strong>: ${submission.status}</p>`;
        }

        return `
            <div class="submission">
                <p><strong>${student.firstName} ${student.lastName}</strong>: ${submission.status}</p>
                <button class="btn btn-info" onclick="viewSubmission('${task._id}', '${student._id}')">View Submission</button>
                <button class="btn btn-primary" onclick="location.href='feedback.html?taskId=${task._id}&studentId=${student._id}'">Enter Progress Report</button>
            </div>
        `;
    }).join('');

    const statusCard = `
        <div class="col-md-4 hwzthat-cards-col">
            <div class="card hwzthat-cards">
                <div class="d-flex align-items-start justify-content-between">
                    <div class="flex-align2 g2 mb-2">
                        <h4 class="mb-0" style="font-size: 14px;">${task.title}</h4>
                        <button class="btn btn-warning btn-sm" style="border-color:#C93232;background: #ffe5e5;color: #C93232;">${task.status}</button>
                    </div>
                </div>
                <div>
                    ${submissionsHtml || '<p>No submissions yet.</p>'}
                </div>
            </div>
        </div>
    `;
    assignmentStatusList.append(statusCard);
});

    }

// Function to view a specific submission (implementation needed)
function viewSubmission(taskId, studentId) {
    const organizationId = localStorage.getItem('organizationId');

    // Fetch the task details
    fetch(`/api/tasks/${taskId}/submission/${studentId}`, {
        headers: { 'organizationId': organizationId }
    })
    .then(response => response.json())
    .then(submission => {
        // Display the submission details in the modal
        console.log(submission);
        $('#modalTaskTitle').text(submission.title || 'No Title');
        $('#modalTaskDescription').text(submission.description || 'No Description');
        const mediaContainer = $('#modalMediaContainer');
        const submissionContent = $('#modalSubmissionContent');
        mediaContainer.empty();
        submissionContent.empty();

        if (submission.media && Object.keys(submission.media).length > 0) {
            Object.keys(submission.media).forEach(mediaKey => {
                const mediaUrl = submission.media[mediaKey];
                
                // Extract media type from base64 string
                const mediaType = mediaUrl.split(';')[0].split(':')[1];
                
                let mediaElement;

                if (mediaType.startsWith('video/')) {
                    mediaElement = `<video controls width="100%">
                                      <source src="${mediaUrl}" type="${mediaType}">
                                      Your browser does not support the video tag.
                                    </video>`;
                } else if (mediaType.startsWith('audio/')) {
                    mediaElement = `<audio controls>
                                      <source src="${mediaUrl}" type="${mediaType}">
                                      Your browser does not support the audio element.
                                    </audio>`;
                } else if (mediaType.startsWith('image/')) {
                    mediaElement = `<img src="${mediaUrl}" alt="Media" style="width: 100%;">`;
                } else {
                    mediaElement = `<p>Unsupported media type.</p>`;
                }

                mediaContainer.append(mediaElement);
            });
        } else {
            mediaContainer.html('<p>No media available</p>');
        }

        if (submission.submissionContent) {
            submissionContent.html(`<p>${submission.submissionContent}</p>`);
        }

        // Show return comment textarea and button based on the current task status
        $('#returnComment').toggle(submission.status === 'submitted');
        $('#returnTaskBtn').toggle(submission.status === 'submitted');

        // Handle the Enter Progress Report button click
        $('#enterProgressReportBtn').off('click').on('click', function() {
            window.location.href = `feedback.html?taskId=${taskId}&studentId=${studentId}`;
        });

        // Handle the Return Task button click
        $('#returnTaskBtn').off('click').on('click', function() {
            const comment = $('#returnComment').val();
            if (comment.trim()) {
                returnTask(taskId, studentId, comment);
            } else {
                alert('Please enter a comment for returning the task.');
            }
        });

        // Open the modal
        $('#viewSubmissionModal').modal('show');
    })
    .catch(error => console.error('Error fetching task:', error));
}

function returnTask(taskId, studentId, comment) {
    const organizationId = localStorage.getItem('organizationId');

    fetch(`/api/tasks/return`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'organizationId': organizationId
        },
        body: JSON.stringify({
            taskId,
            studentId,
            comment
        })
    })
    .then(response => response.json())
    .then(data => {
        alert('Task returned successfully');
        $('#viewSubmissionModal').modal('hide');
        // Optionally, refresh the assignment list or status
    })
    .catch(error => console.error('Error returning task:', error));
}


                </script>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script src="vendors/js/vendor.bundle.base.js"></script>
  <script src="js/off-canvas.js"></script>
  <script src="js/template.js"></script>
</body>

</html>
