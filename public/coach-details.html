<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Coach</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="shortcut icon" href="images/favicon.png" />

  <!-- Include jQuery and Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <script src="components/sidebar.js" type="text/javascript" defer></script>
  <script src="components/topnav.js" type="text/javascript" defer></script>
</head>

<body>
  <div class="container-scroller">
    <topnav-component></topnav-component>

    <div class="container-fluid page-body-wrapper">
      <sidebar-component data-page="coaches"></sidebar-component>

      <div class="main-panel">
        <div class="content-wrapper pt-1">
          <div class="flex-align second-header py-2" style="min-height: 50px; gap:10px">
            <div class="m-0 " style="display: flex; align-items: center; gap:10px;">
              <a href="coaches.html" style="color:gray;">Coach</a>
              <img src="images/arrow-left.png" style="width: 16px;">
              <span id="coach-name">Coach name</span>
            </div>
            <div class="flex-align2 cursor-pointer" style="gap:5px;">
              <img src="images/delete2.png" style="width: 15px; height: 15px; object-fit: contain;">
              <h5>Delete profile</h5>
            </div>
          </div>

          <div class="row m-0 team-row pt-1">
            <div class="team-member-left hwzthat-coaches">
              <div style="display:flex; flex-direction: column; gap:10px">
                <div class="coach-card">
                  <img id="coach-profile-pic" src="images/coach-dp.png" class="coach-dp" alt="Profile Picture">
                  <div class="coach-card-absolute">
                    <h4 id="coach-fullname" class="mb-2 text-white">Coach Name</h4>
                    <h5 id="coach-email" class="text-white" style="opacity: .8; font-weight: 300;">Coach email</h5>
                  </div>
                </div>
                <div class="flex-align2 g1 mt-2">
                  <button class="btn flex-align2 g1 btn-outline-info" style="padding: 10px 15px; border-radius: 20px; font-size: 12px;">
                    <img src="images/chat-btn.png" style="width: 15px;">
                    Chat Now
                  </button>
                  <button class="btn flex-align2 g1 btn-outline-info" style="padding: 10px 15px; border-radius: 20px; font-size: 12px;">
                    <img src="images/schedule-btn.png" style="width: 15px;">
                    Schedule meeting
                  </button>
                </div>
                <div class="mt-3">
                  <h5 class="font-weight-500 mb-1" style="font-size: 14px;">About Me</h5>
                  <h6 id="coach-about" style="font-size: 12px; line-height: 20px; color: #000;">Lorem ipsum dolor sit amet...</h6>
                </div>
                <div class="mt-3">
                  <div class="accordion2 flex-align mb-1 cursor-pointer border-bottom pb-2">
                    <h5 class="font-weight-500" style="font-size: 14px;">Profile details</h5>
                    <img src="images/arrow-down3.png" style="width: 10px; transform: rotate(-90deg);">
                  </div>
                  <div class="panel" style="display: none;">
                    <h6 id="coach-profile-details" style="font-size: 12px; line-height: 20px; color: #000;">Additional details...</h6>
                  </div>
                </div>
              </div>
            </div>

            <div class="team-member-right">
              <div class="hwzthat-tabs">
                <div class="tabs-to-dropdown ">
                  <div class="nav-wrapper d-flex align-items-center justify-content-between mb-2 card">
                    <ul class="nav nav-pills d-md-flex" id="pills-tab" role="tablist">
                      <li class="nav-item" role="presentation">
                        <a class="nav-link active" id="pills-calendar-tab" data-toggle="pill" href="#pills-calendar" role="tab" aria-controls="pills-calendar" aria-selected="true">Calendar</a>
                      </li>
                      <li class="nav-item" role="presentation">
                        <a class="nav-link" id="pills-working_hours-tab" data-toggle="pill" href="#pills-working_hours" role="tab" aria-controls="pills-working_hours" aria-selected="false">Working hours</a>
                      </li>
                      <li class="nav-item" role="presentation">
                        <a class="nav-link" id="pills-leave-tab" data-toggle="pill" href="#pills-leave" role="tab" aria-controls="pills-leave" aria-selected="false">Leave</a>
                      </li>
                      <li class="nav-item" role="presentation">
                        <a class="nav-link" id="pills-payment-tab" data-toggle="pill" href="#pills-payment" role="tab" aria-controls="pills-payment" aria-selected="false">Payment</a>
                      </li>
                    </ul>
                  </div>
                  <div class="tab-content" id="pills-tabContent">
                    <div class="tab-pane fade active show" id="pills-calendar" role="tabpanel" aria-labelledby="pills-calendar-tab">
                      <div>
                        <div class="p-3 flex-align g3 card" style="flex-direction: row;">
                          <div class="flex-align2 g3 px-4">
                            <img src="images/arrow-left-3.png" style="width: 15px;" id="prev-month-btn">
                            <b id="current-month" class="px-2" style="font-size: 14px;"></b>
                            <img src="images/arrow-right-3.png" style="width: 15px;" id="next-month-btn">
                          </div>
                          <ul class="nav nav-pills d-md-flex tab-type-3" id="pills-tab2" role="tablist">
                            <li class="nav-item" role="presentation">
                              <a class="nav-link active" id="pills-month-tab" data-toggle="pill" href="#pills-month" role="tab" aria-controls="pills-month" aria-selected="true">Month</a>
                            </li>
                            <li class="nav-item" role="presentation">
                              <a class="nav-link" id="pills-week-tab" data-toggle="pill" href="#pills-week" role="tab" aria-controls="pills-week" aria-selected="false">Week</a>
                            </li>
                            <li class="nav-item" role="presentation">
                              <a class="nav-link" id="pills-day-tab" data-toggle="pill" href="#pills-day" role="tab" aria-controls="pills-day" aria-selected="false">Day</a>
                            </li>
                          </ul>
                        </div>
                        <div class="tab-content" id="pills-tabContent2">
                          <div class="tab-pane fade active show" id="pills-month" role="tabpanel" aria-labelledby="pills-month-tab">
                            <div class="calender-table3 card" style="border-radius: 0 0 10px 10px;">
                              <table>
                                <thead>
                                  <tr>
                                    <th>Su</th>
                                    <th>Mo</th>
                                    <th>Tu</th>
                                    <th>We</th>
                                    <th>Th</th>
                                    <th>Fr</th>
                                    <th>Sa</th>
                                  </tr>
                                </thead>
                                <tbody id="calendar-body">
                                  <!-- Calendar dates will be dynamically populated -->
                                </tbody>
                              </table>
                            </div>
                            <div id="daily-schedule" class="mt-4">
                              <!-- Daily schedule will be dynamically populated -->
                            </div>
                          </div>
                          <div class="tab-pane fade" id="pills-week" role="tabpanel" aria-labelledby="pills-week-tab">
                            <!-- Weekly view (implement as needed) -->
                          </div>
                          <div class="tab-pane fade" id="pills-day" role="tabpanel" aria-labelledby="pills-day-tab">
                            <div class="vertical-table card" style="border-radius: 0 0 10px 10px;">
                              <table class="w-100" id="daily-timeline">
                                <!-- Daily timeline will be dynamically populated -->
                              </table>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="tab-pane fade" id="pills-working_hours" role="tabpanel" aria-labelledby="pills-working_hours-tab">
                      <div class="card p-md-4 p-2">
                        <!-- Availability will be dynamically populated -->
                        <div id="availability-schedule"></div>
                      </div>
                    </div>

                    <div class="tab-pane fade" id="pills-leave" role="tabpanel" aria-labelledby="pills-leave-tab">
                      <!-- Leave details (implement as needed) -->
                    </div>
                    <div class="tab-pane fade" id="pills-payment" role="tabpanel" aria-labelledby="pills-payment-tab">
                      <!-- Payment details (implement as needed) -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

  </div>

  <script src="js/off-canvas.js"></script>
  <script src="js/template.js"></script>

  <script>
$(document).ready(function () {
  // Attempt to get coachId from URL first
  const urlParams = new URLSearchParams(window.location.search);
  let coachId = urlParams.get('coachId'); // Fetch coachId from the URL
  
  // If coachId is not found in the URL, fetch it from local storage
  if (!coachId) {
    coachId = localStorage.getItem('userId');
    if (!coachId) {
      alert('Coach ID not found. Please make sure you are logged in or accessing the correct page.');
      return;
    }
  }

  // Function to get the current month's name and year
  function getCurrentMonthYear() {
    const now = new Date();
    const monthNames = ["January", "February", "March", "April", "May", "June",
      "July", "August", "September", "October", "November", "December"];
    return `${monthNames[now.getMonth()]} ${now.getFullYear()}`;
  }

  // Load coach details
  function loadCoachDetails() {
    $.ajax({
      url: `/api/user/coach/${coachId}`,
      method: 'GET',
      success: function (response) {
        console.log(response);
        $('#coach-name').text(response.firstName + ' ' + response.lastName);
        $('#coach-fullname').text(response.firstName + ' ' + response.lastName);
        $('#coach-email').text(response.email);
        $('#coach-about').text(response.about);
        if (response.profilePhoto) {
          $('#coach-profile-pic').attr('src', response.profilePhoto);
        }
        $('#coach-profile-details').text(response.coachingSpecialization || 'No additional details.');
      },
      error: function (error) {
        console.error('Error loading coach details:', error);
      }
    });
  }

  // Load calendar and schedule details
  function loadCoachCalendar() {
    const now = new Date();
    const month = now.getMonth() + 1; // Months are 0-based in JS, so we add 1
    const year = now.getFullYear();

    $.ajax({
      url: `/api/user/${coachId}/calendar?month=${month}&year=${year}`,
      method: 'GET',
      success: function (response) {
        const calendarBody = $('#calendar-body');
        calendarBody.empty();

        response.calendar.forEach(week => {
          const weekRow = $('<tr></tr>');
          week.forEach(day => {
            const dayCell = $(`<td>${day ? day.date : ''}</td>`);
            if (day && day.hasSchedule) {
              dayCell.addClass('active');
              dayCell.click(() => loadDailySchedule(day.date));
              day.schedule.forEach(schedule => {
                dayCell.append(`<div>${schedule.timeSlot}: ${schedule.batchName}</div>`);
              });
            }
            weekRow.append(dayCell);
          });
          calendarBody.append(weekRow);
        });

        $('#current-month').text(getCurrentMonthYear());
      },
      error: function (error) {
        console.error('Error loading coach calendar:', error);
      }
    });
  }

  // Load daily schedule
  function loadDailySchedule(date) {
    $.ajax({
      url: `/api/user/${coachId}/schedule/${date}`,
      method: 'GET',
      success: function (response) {
        const dailySchedule = $('#daily-schedule');
        dailySchedule.empty();

        response.schedule.forEach(entry => {
          dailySchedule.append(`
            <div class="schedule-entry">
              <h5>${entry.courseName}</h5>
              <p>Batch: ${entry.batchName}</p>
              <p>Time: ${entry.timeSlot}</p>
              <p>Students: ${entry.studentsCount}</p>
            </div>
          `);
        });
      },
      error: function (error) {
        console.error('Error loading daily schedule:', error);
      }
    });
  }

  // Load working hours
  function loadWorkingHours() {
    $.ajax({
      url: `/api/user/${coachId}/availability`,
      method: 'GET',
      success: function (response) {
        const availabilitySchedule = $('#availability-schedule');
        availabilitySchedule.empty();

        const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        // Iterate over all days of the week and display them
        daysOfWeek.forEach(day => {
          const dayData = response.availability.find(d => d.dayOfWeek === day);
          if (dayData) {
            appendDayRow(day, dayData.isAvailable, dayData.timeSlots[0]?.start || '09:00', dayData.timeSlots[0]?.end || '17:00');
          } else {
            appendDayRow(day, false, '09:00', '17:00');
          }
        });

        // Append update button
        availabilitySchedule.append('<button id="update-availability-btn" class="btn btn-primary">Update Availability</button>');
        
        $('#update-availability-btn').click(updateAvailability);
      },
      error: function (error) {
        console.error('Error loading working hours:', error);
      }
    });
  }

  function appendDayRow(day, isAvailable, start, end) {
    const dayRow = $(`
      <div class="flex-align2 g3 m-2">
        <div class="flex-align2 g2" style="min-width: 150px;">
          <div class="toggle">
            <input type="checkbox" name="${day}" ${isAvailable ? 'checked' : ''}>
            <span class="toggle-bar"></span>
          </div>
          <h5>${day}</h5>
        </div>
        <div class="flex-align2 g2">
          <input type="time" value="${start}" class="hwzthat-input2" ${isAvailable ? '' : 'disabled'}>
          <h6 class="m-0 px-md-4">to</h6>
          <input type="time" value="${end}" class="hwzthat-input2" ${isAvailable ? '' : 'disabled'}>
        </div>
      </div>
    `);

    // Event listener to enable/disable time inputs when toggle is switched
    dayRow.find('input[type="checkbox"]').change(function() {
      const isChecked = $(this).is(':checked');
      dayRow.find('input[type="time"]').prop('disabled', !isChecked);
    });

    $('#availability-schedule').append(dayRow);
  }

  function updateAvailability() {
    const availability = [];

    $('#availability-schedule .flex-align2').each(function(index) {
      const dayOfWeek = $(this).find('h5').text().trim();
      const isAvailable = $(this).find('input[type="checkbox"]').is(':checked');
      
      const timeSlots = [];
      if (isAvailable) {
        const start = $(this).find('input[type="time"]').eq(0).val();
        const end = $(this).find('input[type="time"]').eq(1).val();
        if (start && end) {  // Only push if both start and end are defined
          timeSlots.push({ start, end });
        } else {
          // Handle the case where times are not properly set
          console.error('Start or end time is missing for:', dayOfWeek);
        }
      }

      availability.push({ dayOfWeek, isAvailable, timeSlots });
    });

    $.ajax({
      url: `/api/user/${coachId}/availability`,
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ availability }),
      success: function(response) {
        alert('Availability updated successfully');
      },
      error: function(error) {
        console.error('Error updating availability:', error);
      }
    });
  }

  // Navigate to the previous month
  $('#prev-month-btn').click(function () {
    // Implement month change logic
  });

  // Navigate to the next month
  $('#next-month-btn').click(function () {
    // Implement month change logic
  });

  // Load all details
  loadCoachDetails();
  loadCoachCalendar();
  loadWorkingHours();
});
  </script>

</body>

</html>
