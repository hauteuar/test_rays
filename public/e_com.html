<!DOCTYPE html>
<html lang="en">

<head>
  <title>E-commerce Admin</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/style2.css">
  <link rel="stylesheet" href="css/sidebar.css">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script src="components/topnav.js" type="text/javascript" defer></script>
  <script src="components/sidebar.js" type="text/javascript" defer></script>

  <style>
    .e-com-card {
      width: 100%;
      max-width: 250px;
      margin: auto;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      text-align: center;
      background-color: #f9f9f9;
    }

    .e-com-card img {
      max-width: 100px;
      max-height: 100px;
      margin-bottom: 10px;
      border-radius: 8px;
    }

    .e-com-card .card-title {
      font-size: 1.1rem;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .e-com-card .card-text {
      font-size: 0.9rem;
      color: #555;
    }

    .e-com-card .btn {
      font-size: 0.8rem;
      padding: 5px 10px;
    }
  </style>
</head>

<body>
  <div class="container-scroller">
    <topnav-component></topnav-component>
    <div class="container-fluid page-body-wrapper">
      <sidebar-component data-page="e_com"></sidebar-component>

      <div class="main-section">
        <ul class="nav nav-tabs">
          <li class="nav-item">
            <button class="nav-link active" id="e_com_item-tab" data-bs-toggle="tab" data-bs-target="#e_com_item" type="button" role="tab" aria-controls="e_com_item" aria-selected="true">Items</button>
          </li>
          <li class="nav-item">
            <button class="nav-link" id="purchase_list-tab" data-bs-toggle="tab" data-bs-target="#purchase_list" type="button" role="tab" aria-controls="player-role" aria-selected="false">Purchase list</button>
          </li>
        </ul>
        <div class="tab-content" id="myTabContent">
          <div class="tab-pane fade show active" id="e_com_item" role="tabpanel" aria-labelledby="e_com_item-tab">
            <div class="row mt-3">
              <div class="col-12 py-1 flex-align g2 mb-2">
                <h6 class="font-weight-400">Total items <span id="total-items" class="font-weight-500"> 0</span></h6>
                <a data-bs-toggle="modal" data-bs-target="#addNew" class="btn btn-ramblers px-4">
                  + Add New
                </a>
              </div>

              <!-- Items will be dynamically inserted here -->
              <div id="item-list" class="row g-3">
                <!-- Example of dynamically added item -->
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="purchase_list" role="tabpanel" aria-labelledby="purchase_list-tab">
            <!-- Purchase list content -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Item Modal -->
  <div class="modal fade" id="addNew" tabindex="-1" aria-labelledby="addNewLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-md">
      <div class="modal-content">
        <div class="modal-body p-4">
          <div class="flex-align modal-head2 pb-4 border-bottom">
            <h3 id="modal-title">Add new</h3>
            <img src="images/close.png" data-bs-dismiss="modal" style="cursor: pointer;width: 20px;height: 20px;">
          </div>
          <div class="modal-body2 p-md-3 p-0">
            <div class="mt-3">
              <div class="mb-4">
                <h5 class="font-weight-500 mb-2">Item Name</h5>
                <input type="text" id="itemName" placeholder="Enter item name" class="input w-100">
              </div>
              <div class="mb-4">
                <h5 class="font-weight-500 mb-2">Upload Item Image</h5>
                <div class="input-with-btn flex-align3 mt-3">
                  <input type="text" id="itemImageName" placeholder="Choose file to upload" class="input w-100" readonly>
                  <div class="image-picker" style="position: absolute;right: 0; display: flex; width: min-content;">
                    <input type="file" id="itemImage" accept="image/*" class="input w-100" style="display: none;" onchange="document.getElementById('itemImageName').value = this.files[0].name;">
                    <div class="image-picker-tab btn btn-outline-danger active-btn-danger px-3" style="height: 38px;" onclick="document.getElementById('itemImage').click();">
                      Upload Item Image
                    </div>
                  </div>
                </div>
              </div>
              <div class="mb-4">
                <h5 class="font-weight-500 mb-2">Price (USD)</h5>
                <input type="number" id="itemPrice" placeholder="Enter item price" class="input w-100">
              </div>
              <div class="mb-4">
                <h5 class="font-weight-500 mb-2">Size (Optional)</h5>
                <input type="text" id="itemSize" placeholder="Enter item size" class="input w-100">
              </div>
              <div class="mb-4">
                <h5 class="font-weight-500 mb-2">Stock Quantity</h5>
                <input type="number" id="itemStock" placeholder="Enter stock quantity" class="input w-100">
              </div>
            </div>
            <div class="modal-footer2 d-flex justify-content-end g2 pt-5 mt-4">
              <button type="button" class="btn btn-outline-secondary px-5 w-100" data-bs-dismiss="modal">Cancel</button>
              <button type="button" id="saveItemButton" class="btn btn-ramblers px-5 w-100" onclick="saveNewItem()">Save</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
   const organizationId = localStorage.getItem('organizationId'); // Replace with your actual organization ID
   let editingItemId = null; // Keep track of the item being edited
    
    // Fetch and display items
    async function fetchItems() {
      try {
        const response = await fetch(`/api/items/${organizationId}/items`);
        const items = await response.json();
    
        const itemList = document.getElementById('item-list');
        itemList.innerHTML = '';
    
        items.forEach(item => {
          const itemCard = document.createElement('div');
          itemCard.classList.add('col-xl-3', 'col-lg-4', 'col-md-6', 'col-12', 'mb-4');
          itemCard.innerHTML = `
            <div class="card e-com-card rounded overflow-hidden">
              <div class="dropdown drop-down-official">
                <img src="images/dots.png" class="dropdown-toggle" type="button" data-bs-toggle="dropdown" style="width:15px;height: 15px;object-fit: contain; filter: invert(0) brightness(1);">
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="#" onclick="editItem('${item._id}')">Edit</a></li>
                  <li><a class="dropdown-item" href="#" onclick="deleteItem('${item._id}')">Delete</a></li>
                </ul>
              </div>
              <img src="${item.imageUrl}" class="card-img-top" alt="${item.name}" onclick="editItem('${item._id}')">
              <div class="card-body">
                <h5 class="card-title">${item.name}</h5>
                <p class="card-text">USD ${item.price}</p>
                <p class="card-text">${item.size || ''}</p>
                <p class="card-text">Stock: ${item.stock || 0}</p>
                <button class="btn btn-primary" onclick="addToCart('${item._id}', ${item.price})">Add to Cart</button>
              </div>
            </div>
          `;
          itemList.appendChild(itemCard);
        });
    
        document.getElementById('total-items').textContent = items.length;
      } catch (error) {
        console.error('Error fetching items:', error);
      }
    }
    
    async function saveNewItem() {
  const itemName = document.getElementById('itemName').value;
  const itemPrice = document.getElementById('itemPrice').value;
  const itemSize = document.getElementById('itemSize').value;
  const itemStock = document.getElementById('itemStock').value;
  const itemImage = document.getElementById('itemImage').files[0];
  
  // Validate required fields
  if (!itemName || !itemPrice || !itemImage) {
    alert('Please fill in all required fields (Name, Price, Image).');
    return;
  }
  
  const formData = new FormData();
  formData.append('name', itemName);
  formData.append('price', itemPrice);
  formData.append('size', itemSize);
  formData.append('stock', itemStock);
  formData.append('organizationId', organizationId);
  if (itemImage) {
    formData.append('imageUrl', itemImage);
  }
  
  // Log the FormData content for debugging
  for (let pair of formData.entries()) {
    console.log(`${pair[0]}: ${pair[1]}`);
  }
  
  try {
    let response;
    if (editingItemId) {
      response = await fetch(`/api/items/${organizationId}/items/${editingItemId}`, {
        method: 'PUT',
        body: formData,
      });
    } else {
      response = await fetch(`/api/items/${organizationId}/items`, {
        method: 'POST',
        body: formData,
      });
    }

    if (response.ok) {
      $('#addNew').modal('hide');
      fetchItems(); // Refresh item list
      editingItemId = null; // Reset editing item
    } else {
      const errorData = await response.json();
      console.error('Failed to save item:', errorData);
      alert('Failed to save item. Please check the console for more details.');
    }
  } catch (error) {
    console.error('Error saving item:', error);
  }
}

    
    // Edit item
    async function editItem(itemId) {
      try {
        const response = await fetch(`/api/items/${organizationId}/items/${itemId}`);
        const item = await response.json();
    
        document.getElementById('itemName').value = item.name;
        document.getElementById('itemPrice').value = item.price;
        document.getElementById('itemSize').value = item.size;
        document.getElementById('itemStock').value = item.stock || 0;
        document.getElementById('modal-title').textContent = 'Edit Item';
        editingItemId = itemId;
    
        $('#addNew').modal('show');
      } catch (error) {
        console.error('Error fetching item details:', error);
      }
    }
    
    // Delete item
    async function deleteItem(itemId) {
      if (confirm('Are you sure you want to delete this item?')) {
        try {
          const response = await fetch(`/api/items/${organizationId}/items/${itemId}`, {
            method: 'DELETE',
          });
    
          if (response.ok) {
            fetchItems(); // Refresh item list
          } else {
            console.error('Failed to delete item');
          }
        } catch (error) {
          console.error('Error deleting item:', error);
        }
      }
    }
    
    // Add to cart
    // Add to cart
async function addToCart(itemId, price) {
  const cartData = {
    itemId,
    price,
    itemType: 'ecom',
    status: 'pending',
  };

  try {
    const userId = localStorage.getItem('userId');

    const response = await fetch(`/api/cart/${userId}/add-item/${organizationId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(cartData),
    });

    if (response.ok) {
      // Update cart icon and stock count
      updateCartIcon();

      // Find the item in the DOM and reduce the stock count
      const stockElement = document.querySelector(`.card[data-item-id="${itemId}"] .card-text.stock`);
      if (stockElement) {
        let currentStock = parseInt(stockElement.textContent.replace('Stock: ', ''));
        if (currentStock > 0) {
          stockElement.textContent = `Stock: ${currentStock - 1}`;
        }
      }
    } else {
      console.error('Failed to add item to cart');
    }
  } catch (error) {
    console.error('Error adding item to cart:', error);
  }
}

    // Update cart icon count
    async function updateCartIcon() {
      try {
        const userId = localStorage.getItem('userId');
        const response = await fetch(`/api/cart/${userId}`);
    
        if (response.ok) {
          const cart = await response.json();
          const cartCount = cart.items.length;
          document.getElementById('cart-count').textContent = cartCount;
        } else {
          console.error('Failed to load cart data');
        }
      } catch (error) {
        console.error('Error updating cart icon:', error);
      }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      fetchItems();
      updateCartIcon();
    });
    </script>
</body>

</html>
