<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Courses</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/mobile.css">
    <link rel="stylesheet" href="css/tab.css">
    <link rel="shortcut icon" href="images/1.png" />
    <script src="components/sidebar.js" type="text/javascript" defer></script>
    <script src="components/topnav.js" type="text/javascript" defer></script>
    <style>
        #addAddonsBtn {
            cursor: pointer;
            background-color: #392487;
            color: white;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }

        .addon-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
        }

        .addon-info {
            display: flex;
            align-items: center;
        }

        .addon-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            margin-right: 10px;
        }

        .addon-details h4,
        .addon-details p {
            margin: 0;
        }

        .add-addon-btn {
            margin-left: auto;
            background-color: #4165ff;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .selected-addon {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <div class="container-scroller">
        <topnav-component></topnav-component>
        <div class="container-fluid page-body-wrapper">
            <sidebar-component data-page="courses"></sidebar-component>
            <div class="course-main">
                <div class="mb-3 mt-2">
                    <h4 class="m-0" style="font-weight: 650;">Course</h4>
                </div>
                <div class="row coaches-dropdown align-items-end m-0" style="row-gap:15px;justify-content: space-between;">
                    <div class="pl-0">
                        <h6 class="text-gray package-count" style="font-size: 14px;">Total Courses :
                            <span id="totalCourses">0</span>
                        </h6>
                        <h6 class="text-gray package-count" style="font-size: 14px;">Packages :
                            <span id="totalPackages">0</span>
                        </h6>
                        <h6 class="text-gray package-count" style="font-size: 14px;">Assigned Courses :
                            <span id="assignedCourses">0</span>
                        </h6>
                        <h6 class="text-gray package-count" style="font-size: 14px;">Enrolled Students :
                            <span>123</span>
                        </h6>
                    </div>

                    <div class="dropdown" style="padding: 0 6px;">
                        <button class="btn site-btn-success dropdown-btn2" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" style="font-size: 15px; white-space: nowrap;font-weight: 500;">
                            <span>+</span> Create new <img src="images/arrow-down3.png" style="filter: invert(1);height: 6px;margin-top: 1px;">
                        </button>
                        <div class="dropdown-menu dropdown-menu-right p-0" aria-labelledby="dropdownMenuButton">
                            <a href="new-course.html" class="dropdown-item">Course</a>
                            <a class="dropdown-item" data-toggle="modal" data-target="#add-package">Add Package</a>
                        </div>
                    </div>
                </div>
                <div class="radios">
                    <label for="all"><input name="radio" type="radio" id="all" checked>All</label>
                    <label for="active"><input name="radio" type="radio" id="active">Active</label>
                    <label for="not-assigned"><input name="radio" type="radio" id="not-assigned">Not assigned</label>
                    <label for="expired"><input name="radio" type="radio" id="expired">Expired</label>
                </div>
                <div class="package-container" id="coursesContainer">
                    <!-- Courses will be dynamically added here -->
                </div>
                <div class="package-heading">
                    <h4>Packages</h4>
                </div>
                <div class="package-container" id="packagesContainer">
                    <!-- Packages will be dynamically added here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add Package Modal -->
    <div class="modal fade " id="add-package">
        <div class="modal-dialog modal-md" role="document" style="max-width: 840px;">
            <div class="modal-content">
                <div class="modal-header align-items-center">
                    <h5 class="modal-title" id="coachModalLabel">Add Package</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: calc(100vh - 180px); overflow: auto;">
                    <div class="row" style="row-gap:20px">
                        <div class="col-12">
                            <h6 class="mb-2">Package name</h6>
                            <input type="text" id="packageName" placeholder="Enter package name" name="packageName" class="hwzthat-input w-100">
                        </div>
                        <div class="col-12">
                            <h6 class="mb-2">Please select which courses you want to add to this package.</h6>
                            <select class="hwzthat-input w-100" id="packageCourses" name="packageCourses" multiple>
                                <!-- Courses will be dynamically added here -->
                            </select>
                        </div>
                        <div class="col-6">
                            <h6 class="mb-2">Package fee</h6>
                            <input type="number" id="packageFee" placeholder="Enter package fee" name="packageFee" class="hwzthat-input w-100">
                        </div>
                        <div class="col-6">
                            <h6 class="mb-2">Package discount</h6>
                            <input type="number" id="packageDiscount" placeholder="Enter package discount % or discount amount" name="packageDiscount" class="hwzthat-input w-100">
                        </div>
                        <div class="col-6">
                            <h6 class="mb-2">Start date</h6>
                            <input type="date" id="packageStartDate" name="packageStartDate" class="hwzthat-input w-100">
                        </div>
                        <div class="col-6">
                            <h6 class="mb-2">End date</h6>
                            <input type="date" id="packageEndDate" name="packageEndDate" class="hwzthat-input w-100">
                        </div>
                        <div class="col-12" style="border-bottom: 1px solid #ddd;">
                            <h3 class="batch-subheading" style="font-size: 13px;font-weight: 500;color:#392487">
                                <span style="color: #392487;">+</span>Add new discount
                            </h3>
                        </div>
                        <div class="col-12 addons">
                            <div class="col-12" style="padding-left: 0px;">
                                <h3 class="batch-subheading" style="font-size: 13px;font-weight: 500;">Add ons</h3>
                            </div>
                            <div id="selectedAddons" class="col-12 selected-addons-list" style="margin-bottom: 10px;">
                                <!-- Selected add-ons will appear here -->
                            </div>

                        </div>
                        <div class="col-12" style="padding-left: 0px;flex: 0 0 60%;">
                            <button id="addAddonsBtn" class="btn site-btn-info" type="button">+ Add add ons</button>
                        </div>
                        <div class="col-12" style="margin-top: 70px;">
                            <h6 class="mb-2">Package description</h6>
                            <textarea id="packageDescription" class="col-12 description" placeholder="Enter description" style="border-radius: 5px;font-size: 13px;height: 120px;"></textarea>
                        </div>
                        <div class="col-12">
                            <h6 class="mb-2">Upload image</h6>
                            <div class="add-package-file">
                                <img src="images/download.png" alt="">
                                <label for="add-package-file">Upload image</label>
                                <input id="add-package-file" type="file" name="bannerImage" class="hwzthat-input w-100" style="display: none;">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex align-items-center mt-4 p-3" style="gap:10px;gap: 10px;justify-content: flex-end;border-top: 1px solid #39248726;">
                    <button class="site-btn-outline-info hoverbtn px-5" data-dismiss="modal" aria-label="Close">Cancel</button>
                    <button class="site-btn-success hoverbtn px-5" id="savePackageBtn" style="background-color: #4165ff;border-color: #4165ff;">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add-ons Modal -->
    <div class="modal fade" id="addonsModal" tabindex="-1" role="dialog" aria-labelledby="addonsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addonsModalLabel">Add Add-ons</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="addonsContainer">
                    <!-- Add-ons items will be listed here dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn site-btn-success" data-dismiss="modal">Done</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="js/off-canvas.js"></script>
    <script src="js/template.js"></script>
    <script>
        const coursesContainer = document.getElementById('coursesContainer');
        const packagesContainer = document.getElementById('packagesContainer');
        const totalCourses = document.getElementById('totalCourses');
        const totalPackages = document.getElementById('totalPackages');
        const assignedCourses = document.getElementById('assignedCourses');
        const packageCoursesSelect = document.getElementById('packageCourses');
        const savePackageBtn = document.getElementById('savePackageBtn');
        const addAddonsBtn = document.getElementById('addAddonsBtn');
        const selectedAddonsContainer = document.getElementById('selectedAddons');
        const addonsModal = $('#addonsModal');
        const addonsContainer = document.getElementById('addonsContainer');

        if (addAddonsBtn) {
            addAddonsBtn.addEventListener('click', async () => {
                try {
                    const organizationId = localStorage.getItem('organizationId');
                    const response = await fetch(`/api/items/${organizationId}/items`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    const items = await response.json();
                    displayItemsAsAddons(items);
                    addonsModal.modal('show');
                } catch (error) {
                    console.error('Error fetching items:', error);
                }
            });
        }

        if (savePackageBtn) {
            savePackageBtn.addEventListener('click', addPackage);
        }

        const today = new Date();
        const organizationName = localStorage.getItem('organizationName');
        const organizationId = localStorage.getItem('organizationId');

        async function fetchCourses() {
            try {
                const response = await fetch('/api/courses', {
                    headers: { 'organizationId': organizationId }
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const courses = await response.json();
                console.log("Fetched courses:", courses);
                populateCoursesDropdown(courses);
                categorizeCourses(courses);
                updateCourseCounters(courses);
            } catch (error) {
                console.error('Error fetching courses:', error);
            }
        }

        async function fetchPackages() {
            try {
                const response = await fetch(`/api/package/packages/${organizationId}`, {
                    headers: { 'organizationId': organizationId }
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const packages = await response.json();
                console.log("Fetched packages:", packages);
                categorizePackages(packages);
            } catch (error) {
                console.error('Error fetching packages:', error);
            }
        }

        function populateCoursesDropdown(courses) {
            packageCoursesSelect.innerHTML = '';
            courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course._id;
                option.textContent = course.title;
                packageCoursesSelect.appendChild(option);
            });
        }

        function categorizeCourses(courses) {
            const allCourses = [];
            const activeCourses = [];
            const notAssignedCourses = [];
            const expiredCourses = [];

            courses.forEach(course => {
                const startDate = new Date(course.startDate);
                const endDate = new Date(course.endDate);

                if (startDate <= today && endDate >= today) {
                    course.status = 'Active';
                    activeCourses.push(course);
                } else if (startDate > today) {
                    course.status = 'Not Assigned';
                    notAssignedCourses.push(course);
                } else if (endDate < today) {
                    course.status = 'Expired';
                    expiredCourses.push(course);
                }

                allCourses.push(course);
            });

            console.log("Categorized all courses:", allCourses);
            displayCourses(allCourses, 'all');
        }

        function categorizePackages(packages) {
            const allPackages = [];
            const activePackages = [];
            const notAssignedPackages = [];
            const expiredPackages = [];

            packages.forEach(pkg => {
                const startDate = new Date(pkg.startDate);
                const endDate = new Date(pkg.endDate);

                if (startDate <= today && endDate >= today) {
                    pkg.status = 'Active';
                    activePackages.push(pkg);
                } else if (startDate > today) {
                    pkg.status = 'Not Assigned';
                    notAssignedPackages.push(pkg);
                } else if (endDate < today) {
                    pkg.status = 'Expired';
                    expiredPackages.push(pkg);
                }

                allPackages.push(pkg);
            });

            displayPackages(allPackages, 'all');
        }

        function displayCourses(courses, category) {
            const container = document.getElementById('coursesContainer');
            console.log(`Displaying ${category} courses:`, courses);

            container.innerHTML = '';
            courses.forEach(course => {
                const imageUrl = course.bannerImage ? `/images/${course.bannerImage}` : 'images/summer-camp.jpg';
                const courseElement = document.createElement('div');
                courseElement.classList.add('package');
                courseElement.innerHTML = `
                    <div class="package-image">
                        <img src="${imageUrl}" alt="${course.title}" onerror="this.onerror=null; this.src='images/summer-camp.jpg'">
                        <div class="status-ribbon">
                            <h4>${course.status}</h4>
                        </div>
                    </div>
                    <div class="bottom">
                        <div class="text">
                            <h4>${course.title}</h4>
                        </div>
                        <div class="course-details">
                            <h4><span>Start Date: </span>${new Date(course.startDate).toLocaleDateString()}</h4>
                            <h4><span>End Date: </span>${new Date(course.endDate).toLocaleDateString()}</h4>
                        </div>
                    </div>
                `;
                courseElement.onclick = () => window.location.href = `course-details.html?courseId=${course._id}`;
                container.appendChild(courseElement);
            });
        }

        function displayPackages(packages, category) {
            const container = document.getElementById('packagesContainer');
            console.log(`Displaying ${category} packages:`, packages);

            container.innerHTML = '';
            packages.forEach(pkg => {
                const imageUrl = pkg.bannerImage ? `/images/${pkg.bannerImage}` : 'images/default-package.jpg';
                const packageElement = document.createElement('div');
                packageElement.classList.add('package');
                packageElement.innerHTML = `
                    <div class="package-image">
                        <img src="${imageUrl}" alt="${pkg.name}" onerror="this.onerror=null; this.src='images/default-package.jpg'">
                        <div class="status-ribbon">
                            <h4>${pkg.status}</h4>
                        </div>
                    </div>
                    <div class="bottom">
                        <div class="text">
                            <h4>${pkg.name}</h4>
                        </div>
                        <div class="course-details">
                            <h4><span>Courses: </span>${pkg.courses.length}</h4>
                            <h4><span>Start Date: </span>${new Date(pkg.startDate).toLocaleDateString()}</h4>
                            <h4><span>End Date: </span>${new Date(pkg.endDate).toLocaleDateString()}</h4>
                        </div>
                    </div>
                `;
                packageElement.onclick = () => window.location.href = `package-details.html?packageId=${pkg._id}`;
                container.appendChild(packageElement);
            });
        }

        function updateCourseCounters(courses) {
            totalCourses.textContent = courses.length;
            assignedCourses.textContent = courses.filter(course => course.status === 'Active').length;
        }

        function filterCourses(category) {
            const courses = document.querySelectorAll('.package-container .package');

            courses.forEach(course => {
                course.style.display = 'none';
                if (category === 'all' || course.querySelector('.status-ribbon h4').textContent === category) {
                    course.style.display = 'block';
                }
            });
        }

        document.getElementById('all').addEventListener('click', () => filterCourses('all'));
        document.getElementById('active').addEventListener('click', () => filterCourses('Active'));
        document.getElementById('not-assigned').addEventListener('click', () => filterCourses('Not Assigned'));
        document.getElementById('expired').addEventListener('click', () => filterCourses('Expired'));

        function displayItemsAsAddons(items) {
            addonsContainer.innerHTML = '';
            items.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.classList.add('addon-item');
                itemElement.innerHTML = `
                    <div class="addon-info">
                        <img src="${item.imageUrl}" alt="${item.name}" class="addon-image">
                        <div class="addon-details">
                            <h4>${item.name}</h4>
                            <p>${item.description}</p>
                            <h4>$${item.price}</h4>
                        </div>
                    </div>
                    <button class="site-btn-success add-addon-btn" data-item-id="${item._id}">Add Item</button>
                `;
                addonsContainer.appendChild(itemElement);

                itemElement.querySelector('.add-addon-btn').addEventListener('click', () => {
                    addSelectedAddon(item._id, items);
                });
            });
        }

        function addSelectedAddon(itemId, items) {
            const selectedItem = items.find(item => item._id === itemId);
            if (selectedItem) {
                const selectedAddonElement = document.createElement('div');
                selectedAddonElement.classList.add('selected-addon');
                selectedAddonElement.setAttribute('data-item-id', selectedItem._id);
                selectedAddonElement.innerHTML = `
                    <div class="addon-info">
                        <img src="${selectedItem.imageUrl}" alt="${selectedItem.name}" class="addon-image">
                        <div class="addon-details">
                            <h4>${selectedItem.name}</h4>
                            <h4>$${selectedItem.price}</h4>
                        </div>
                    </div>
                `;
                selectedAddonsContainer.appendChild(selectedAddonElement);
            }
        }

        async function addPackage() {
    try {
        const packageName = document.getElementById('packageName').value;
        const packageCourses = Array.from(packageCoursesSelect.selectedOptions).map(option => option.value);
        console.log(packageCourses); // Verify the courses array
        const packageFee = document.getElementById('packageFee').value;
        const packageDiscount = document.getElementById('packageDiscount').value;
        const packageDescription = document.getElementById('packageDescription').value;
        const packageStartDate = document.getElementById('packageStartDate').value;
        const packageEndDate = document.getElementById('packageEndDate').value;
        const bannerImageFile = document.getElementById('add-package-file').files[0];

        const selectedAddons = Array.from(selectedAddonsContainer.children).map(addon => addon.getAttribute('data-item-id'));

        const formData = new FormData();
        formData.append('name', packageName);
        formData.append('courses', JSON.stringify(packageCourses)); // Stringify the array before appending
        formData.append('items', JSON.stringify(selectedAddons)); // Stringify the array before appending
        formData.append('fee', packageFee);
        formData.append('discount', packageDiscount);
        formData.append('description', packageDescription);
        formData.append('startDate', packageStartDate);
        formData.append('endDate', packageEndDate);
        console.log(...formData); // Log the FormData contents for debugging

        const organizationId = localStorage.getItem('organizationId');
        if (bannerImageFile) {
            formData.append('bannerImage', bannerImageFile);
        }

        const response = await fetch('/api/package/add-package', {
            method: 'POST',
            headers: {
                'organizationId': organizationId
            },
            body: formData
        });

        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const result = await response.json();
        console.log('Package added:', result);

        // Close the modal and redirect to the main screen
        $('#add-package').modal('hide');
        window.location.href = '/courses.html';
    } catch (error) {
        console.error('Error creating package:', error);
    }
}

        fetchCourses();
        fetchPackages();
    </script>
</body>

</html>
