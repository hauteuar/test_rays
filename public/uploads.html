<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Upload and View Tasks</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/mobile.css">
  <link rel="stylesheet" href="css/tab.css">
  <link rel="shortcut icon" href="images/1.png" />

  <!-- Include jQuery and Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <script src="components/sidebar.js" type="text/javascript" defer></script>
  <script src="components/topnav.js" type="text/javascript" defer></script>

  <style>
    .tab-container {
      margin-top: 20px;
    }

    .nav-tabs {
      margin-bottom: 20px;
    }

    .upload-form {
      /*background-color: white; */
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .upload-form h5 {
      margin-bottom: 15px;
    }

    .upload-form label {
      font-weight: bold;
    }

    
    .upload-form select {
    width: 100%;
    padding: 8px;
    margin-bottom: 10px;
    border-radius: 4px;

   /* border: 1px solid #ddd;
    /*background-color: #ffffff; /* Set background color */
    color: #333333 !important; /* Set text color */
    font-size: 16px; /* Optional: adjust font size */
}

.upload-form select option {
    color: #333333 !important; /* Ensure option text is also visible */
    /*background-color: #ffffff; /* Ensure option background matches the select background */
}

    .upload-form input[type="file"],
    .upload-form textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }

    .upload-form textarea {
      height: 100px;
      resize: vertical;
    }
   
    .upload-form button {
      background-color: #28a745;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .upload-form button:disabled {
      background-color: #c0c0c0;
    }

    .task-table {
      width: 100%;
      margin-top: 15px;
      border-collapse: collapse;
    }

    .task-table th,
    .task-table td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
    }

    .task-table th {
      background-color: #f4f4f4;
    }

    .task-table tbody tr:hover {
      background-color: #f9f9f9;
    }
  </style>
</head>

<body>
  <div class="container-scroller">
    <div class="container-fluid page-body-wrapper">
      <sidebar-component data-page="upload-task"></sidebar-component>
      <topnav-component></topnav-component>
      <div class="course-main billing">
        <div class="tab-container">
          <ul class="nav nav-tabs">
            <li class="nav-item">
              <a class="nav-link active" id="upload-tab" data-toggle="tab" href="#upload" role="tab">Submit Task</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="view-tab" data-toggle="tab" href="#view" role="tab">View Submitted Tasks</a>
            </li>
          </ul>
          <div class="tab-content">
            <!-- Submit Task Tab -->
            <div class="tab-pane fade show active" id="upload" role="tabpanel">
              <div class="upload-container">
                <div class="upload-form">
                  <h5>Submit Individual Task</h5>
                  <label for="coach-select">Select Coach</label>
                  <select id="coach-select" style="color: black;">
                    <!-- Coach options will be populated by JavaScript -->
                  </select>

                  <label for="upload-type">Upload Type</label>
                  <select id="upload-type">
                    <option value="image">Image</option>
                    <option value="video">Video</option>
                    <option value="audio">Audio</option>
                    <option value="text">Text</option>
                  </select>

                  <label for="upload-file">Upload File</label>
                  <input type="file" id="upload-file" accept="image/*,video/*,audio/*,.txt">

                  <label for="description">Description</label>
                  <textarea id="description" placeholder="Enter a description (optional)"></textarea>

                  <button id="submit-task-button">Submit Task</button>
                </div>
              </div>
            </div>

            <!-- View Submitted Tasks Tab -->
            <div class="tab-pane fade" id="view" role="tabpanel">
              <h5>Submitted Tasks</h5>
              <table class="task-table">
                <thead>
                  <tr>
                    <th>Task ID</th>
                    <th>Coach</th>
                    <th>Upload Type</th>
                    <th>Status</th>
                    <th>Description</th>
                    <th>Submission Date</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="task-list">
                  <!-- Task rows will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const userId = localStorage.getItem('userId');
      const organizationId = localStorage.getItem('organizationId');
      const coachSelect = document.getElementById('coach-select');

      // Fetch the list of coaches assigned to the student
      async function fetchCoaches() {
        try {
          const response = await fetch(`/api/user/organization/${organizationId}/coaches`, {
            headers: {
              'Content-Type': 'application/json',
              'organizationId': organizationId
            }
          });

          const coaches = await response.json();
          console.log(coaches);
          coaches.forEach(coach => {
            const option = document.createElement('option');
            option.value = coach._id;
            option.textContent = coach.name;
            option.style.color = 'black'; // Set text color to black explicitly
            coachSelect.appendChild(option);
          });
        } catch (error) {
          console.error('Error fetching coaches:', error);
        }
      }

      fetchCoaches();

      // Handle the task submission
      document.getElementById('submit-task-button').addEventListener('click', async function () {
    const selectedCoach = document.getElementById('coach-select').value;
    const uploadType = document.getElementById('upload-type').value;
    const fileInput = document.getElementById('upload-file');
    let description = document.getElementById('description').value;

    if (!selectedCoach || !fileInput.files.length) {
        alert('Please select a coach and upload a file.');
        return;
    }

    const formData = new FormData();
    formData.append('studentId', userId);
    formData.append('assignedBy', selectedCoach);
    formData.append('taskType', 'student-initiated');
    formData.append('submissionType', uploadType);
    formData.append('submissionContent', description || 'No content'); // Ensure submissionContent is present
    formData.append('description', description);
    formData.append('organizationId', organizationId);
    formData.append('title', userId + 'task');
    formData.append('assignedTo', userId);

    // Add each selected file to the form data
    Array.from(fileInput.files).forEach((file, index) => {
        formData.append('mediaFiles', file);  // Use the key 'mediaFiles' to match with multer middleware
    });

    try {
        const response = await fetch('/api/tasks/', {
            method: 'POST',
            headers: {
                'organizationId': organizationId
            },
            body: formData
        });

        if (response.ok) {
            alert('Task submitted successfully.');
            // Clear the form
            document.getElementById('upload-file').value = '';
            document.getElementById('description').value = '';
        } else {
            alert('Failed to submit task.');
        }
    } catch (error) {
        console.error('Error submitting task:', error);
        alert('An error occurred while submitting the task.');
    }
});



      // Fetch and display submitted tasks
      async function loadTasks() {
    try {
        const response = await fetch(`/api/tasks/student/${userId}/${organizationId}`, {
            headers: {
                'Content-Type': 'application/json',
                'organizationId': organizationId
            }
        });

        if (!response.ok) {
            console.error('Failed to load tasks');
            return;
        }

        const tasks = await response.json();
        console.log('Tasks:', tasks);  // Log the tasks to inspect the structure

        const taskList = document.getElementById('task-list');
        taskList.innerHTML = '';

        tasks.forEach(task => {
            const row = document.createElement('tr');

            row.innerHTML = `
                <td>${task._id}</td>
                <td>${task.assignedBy ? task.assignedBy.firstName : 'N/A'}</td>  <!-- Use the correct path for coachName -->
                <td>${task.submissionType || 'N/A'}</td>  <!-- Use the correct path for submissionType -->
                <td>${task.status || 'N/A'}</td>
                <td>${task.description || 'No description'}</td>
                <td>${new Date(task.createdAt).toLocaleDateString()}</td>
                <td><a href="${task.media ? task.mediaUrl : '#'}" target="_blank">View</a></td>  <!-- Check if mediaUrl is correct -->
            `;

            taskList.appendChild(row);
        });
    } catch (error) {
        console.error('Error loading tasks:', error);
    }
}

      // Load tasks when the "View Submitted Tasks" tab is clicked
      document.getElementById('view-tab').addEventListener('click', loadTasks);

      // Initial load of tasks if the tab is already active
      if (document.getElementById('view-tab').classList.contains('active')) {
        loadTasks();
      }
    });
  </script>
</body>

</html>
