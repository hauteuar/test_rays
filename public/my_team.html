<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Session Planning</title>
  <link rel="stylesheet" href="css/style-coach.css">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/mobile.css">
  <link rel="stylesheet" href="css/tab.css">
  <link rel="shortcut icon" href="images/favicon.png" />
  <script src="components/sidebar.js" type="text/javascript" defer></script>
  <script src="components/topnav.js" type="text/javascript" defer></script>
  <style>
    .popup {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 400px;
      background-color: #fff;
      border: 1px solid #ccc;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      text-align: center;
    }
    .popup video, .popup audio {
      width: 100%;
      height: auto;
    }
    .popup button {
      margin: 10px 5px;
    }
    .overlay {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }
    .session-planning {
      margin-top: 20px;
    }
    .session-planning .category {
      margin-bottom: 20px;
    }
    .session-planning .category h5 {
      margin-bottom: 10px;
      font-weight: 600;
    }
    .session-planning .category .student-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .session-planning .category .student-list .student-item {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      cursor: pointer;
      background-color: #f8f9fa;
    }
    .session-planning .category .student-list .student-item.active {
      background-color: #e2e6ea;
    }
  </style>
</head>
<body>
  <div class="container-scroller">
    <topnav-component></topnav-component>
    <div class="container-fluid page-body-wrapper">
      <sidebar-component data-page="my-team"></sidebar-component>
      <div class="main-panel">
        <div class="flex-align second-header px-4 py-2" style="border-bottom: 1px solid #D9D8D8;min-height: 60px;gap:10px">
          <h4 class="m-0">Session Planning</h4>
        </div>
        <div class="content-wrapper">
          <div class="row mt-3">
            <div class="col-md-6">
              <label>Select Course</label>
              <select id="courseSelect" onchange="fetchStudentsForSelectedCourse()">
                <option value="">Select Course</option>
                <!-- Courses will be dynamically loaded here -->
              </select>
            </div>
            <div class="col-md-6">
              <label>Select Player</label>
              <select id="studentSelect" multiple>
                <!-- Player options will be dynamically loaded here -->
              </select>
            </div>
          </div>
          <div class="session-planning mt-4">
            <div class="category">
              <h5>Batting</h5>
              <div class="student-list" id="battingList">
                <!-- Batting students will be dynamically loaded here -->
              </div>
            </div>
            <div class="category">
              <h5>Bowling</h5>
              <div class="student-list" id="bowlingList">
                <!-- Bowling students will be dynamically loaded here -->
              </div>
            </div>
            <div class="category">
              <h5>Fielding</h5>
              <div class="student-list" id="fieldingList">
                <!-- Fielding students will be dynamically loaded here -->
              </div>
            </div>
          </div>
          <div class="mt-4">
            <button class="site-btn-success hoverbtn px-5" id="saveSessionPlanBtn">Save Session Plan</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay and Popup for recording -->
  <div class="overlay" id="overlay"></div>
  <div class="popup" id="popup">
    <video id="videoPreview" controls style="display: none;"></video>
    <audio id="audioPreview" controls style="display: none;"></audio>
    <button id="pauseButton">Pause</button>
    <button id="resumeButton">Resume</button>
    <button id="stopButton">Stop</button>
    <button id="saveButton">Save</button>
  </div>

  <!-- Replacing vendor.bundle.base.js with CDN links for required libraries -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let sessionPlan = {
      batting: [],
      bowling: [],
      fielding: []
    };

    async function fetchCoursesAndStudents(coachId) {
      try {
        const organizationId = localStorage.getItem('organizationId');
        const courseSelect = document.getElementById('courseSelect');

        if (!coachId) {
          throw new Error('Coach ID is missing');
        }

        // Fetch the user profile to get the list of courses
        const profileResponse = await fetch(`/api/user/coach/${coachId}`, {
          headers: { 'organizationId': organizationId }
        });

        if (!profileResponse.ok) {
          throw new Error('Failed to fetch coach profile');
        }

        const profile = await profileResponse.json();
        
        if (!profile.organizations || profile.organizations.length === 0) {
          throw new Error('No organizations found for this coach');
        }

        const courses = profile.organizations[0]?.courses || [];

        if (courses.length === 0) {
          throw new Error('No courses found for this coach');
        }

        // Populate the course dropdown
        courseSelect.innerHTML = '<option value="">Select Course</option>';
        courses.forEach(course => {
          const option = document.createElement('option');
          option.value = course.course_id || course._id;
          option.textContent = `Course ID: ${course.course_id || course._id}`;
          courseSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error fetching courses and students:', error);
      }
    }

    async function fetchStudentsForSelectedCourse() {
      try {
        const courseSelect = document.getElementById('courseSelect');
        const coachId = localStorage.getItem('userId');
        const organizationId = localStorage.getItem('organizationId');
        const studentSelect = document.getElementById('studentSelect');
        const battingList = document.getElementById('battingList');
        const bowlingList = document.getElementById('bowlingList');
        const fieldingList = document.getElementById('fieldingList');

        if (courseSelect.value) {
          const studentsResponse = await fetch(`/api/user/assigned-student/${courseSelect.value}/${coachId}`, {
            headers: { 'organizationId': organizationId }
          });

          if (!studentsResponse.ok) {
            throw new Error('Failed to fetch students');
          }

          const students = await studentsResponse.json();
          
          // Clear existing student lists
          studentSelect.innerHTML = '<option value="">Select Student</option>';
          battingList.innerHTML = '';
          bowlingList.innerHTML = '';
          fieldingList.innerHTML = '';

          students.forEach(student => {
            const option = document.createElement('option');
            option.value = student._id;
            option.textContent = `${student.firstName} ${student.lastName}`;
            studentSelect.appendChild(option);

            // Add students to session planning lists
            addStudentToCategory(student, 'batting', battingList);
            addStudentToCategory(student, 'bowling', bowlingList);
            addStudentToCategory(student, 'fielding', fieldingList);
          });
        }
      } catch (error) {
        console.error('Error fetching students for selected course:', error);
      }
    }

    function addStudentToCategory(student, category, listElement) {
      const studentItem = document.createElement('div');
      studentItem.className = 'student-item';
      studentItem.textContent = `${student.firstName} ${student.lastName}`;
      studentItem.addEventListener('click', () => toggleStudentSelection(student, category, studentItem));
      listElement.appendChild(studentItem);
    }

    function toggleStudentSelection(student, category, studentItem) {
      const studentIndex = sessionPlan[category].indexOf(student._id);

      if (studentIndex > -1) {
        sessionPlan[category].splice(studentIndex, 1);
        studentItem.classList.remove('active');
      } else {
        sessionPlan[category].push(student._id);
        studentItem.classList.add('active');
      }
    }

    document.getElementById('saveSessionPlanBtn').addEventListener('click', () => {
      console.log('Session Plan:', sessionPlan);
      alert('Session Plan saved!');
      // Save session plan logic here
    });

    document.addEventListener('DOMContentLoaded', async () => {
      const coachId = localStorage.getItem('userId');
      await fetchCoursesAndStudents(coachId);
    });

    // Additional code for recording and uploads
    let uploadedFiles = [];
    let mediaRecorder;
    let chunks = [];

    document.getElementById('uploadFile').addEventListener('click', () => {
      document.getElementById('fileInput').click();
    });

    document.getElementById('fileInput').addEventListener('change', (event) => {
      uploadedFiles = Array.from(event.target.files);
    });

    document.getElementById('recordAudio').addEventListener('click', async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = event => chunks.push(event.data);
        mediaRecorder.onstop = () => handleMediaStop('audio');

        showPopup();
        mediaRecorder.start();
      } catch (error) {
        console.error('Error recording audio:', error);
      }
    });

    document.getElementById('useCamera').addEventListener('click', async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/mp4' });
        mediaRecorder.ondataavailable = event => chunks.push(event.data);
        mediaRecorder.onstop = () => handleMediaStop('video');

        showPopup(stream);
        mediaRecorder.start();
      } catch (error) {
        console.error('Error recording video:', error);
      }
    });

    document.getElementById('pauseButton').addEventListener('click', () => {
      mediaRecorder.pause();
    });

    document.getElementById('resumeButton').addEventListener('click', () => {
      mediaRecorder.resume();
    });

    document.getElementById('stopButton').addEventListener('click', () => {
      mediaRecorder.stop();
    });

    document.getElementById('saveButton').addEventListener('click', () => {
      const blob = new Blob(chunks, { type: mediaRecorder.mimeType });
      const file = new File([blob], `recorded-${Date.now()}.${mediaRecorder.mimeType.split('/')[1]}`);
      uploadedFiles.push(file);
      hidePopup();
    });

    function showPopup(stream) {
      document.getElementById('overlay').style.display = 'block';
      document.getElementById('popup').style.display = 'block';
      if (stream) {
        document.getElementById('videoPreview').style.display = 'block';
        document.getElementById('videoPreview').srcObject = stream;
      } else {
        document.getElementById('audioPreview').style.display = 'block';
      }
    }

    function hidePopup() {
      document.getElementById('overlay').style.display = 'none';
      document.getElementById('popup').style.display = 'none';
      document.getElementById('videoPreview').style.display = 'none';
      document.getElementById('audioPreview').style.display = 'none';
      document.getElementById('videoPreview').srcObject = null;
      chunks = [];
    }

    function handleMediaStop(type) {
      const mediaElement = type === 'video' ? document.getElementById('videoPreview') : document.getElementById('audioPreview');
      mediaElement.src = URL.createObjectURL(new Blob(chunks, { type: mediaRecorder.mimeType }));
      mediaElement.controls = true;
      mediaElement.play();
    }
  </script>
</body>
</html>
