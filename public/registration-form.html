<!DOCTYPE html>
<html lang="en">
<head>
  <title>Admin</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/mobile.css">
  <link rel="stylesheet" href="/css/tab.css">
  <link rel="stylesheet" href="/css/calendar.css">
  <link rel="stylesheet" href="css/style22.css">
  <link rel="stylesheet" href="css/style2.css">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script src="components/topnav.js" type="text/javascript" defer></script>
  <script src="components/sidebar.js" type="text/javascript" defer></script>
</head>
<body>
  <div class="container-scroller">
    <topnav-component></topnav-component>
    <div class="container-fluid page-body-wrapper">
      <sidebar-component data-page="registration-form"></sidebar-component>
      <div class="main-section main-section2">
        <div class="tab1" id="registration">
          <div class="filter-bar mt-3" style="align-items: flex-end;">
            <h5 class="font-weight-400 text-4">Total <span class="font-weight-600">03</span></h5>
            <a id="create-new-btn" class="btn btn-ramblers px-4">
              + Create New
            </a>
          </div>
          <div class="row mx-0 mt-3" style="row-gap:25px;">
            <div class="col-12 p-0">
              <div class="table-sec" style="overflow: auto; min-height: auto;">
                <table class="table1">
                  <thead>
                    <tr>
                      <th class="text-gray">Created date</th>
                      <th class="text-gray">Category</th>
                      <th class="text-gray">Title</th>
                      <th class="text-gray">Status</th>
                      <th class="text-gray">Document</th>
                    </tr>
                  </thead>
                  <tbody id="document-list">
                    <!-- Documents will be populated here by JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div class="tab2" id="registration_form" style="display: none;">
          <div class="flex-align3 g4 mt-4 cursor-pointer">
            <a id="registration_btn">
              <img src="images/rounded-left.png" style="width:30px;object-fit: contain;">
            </a>
            <h4>Create new form</h4>
          </div>
          <div class="mt-4" style="padding-left: 50px; max-width: 1000px;">
            <div class="row mt-3" style="row-gap: 10px;">
              <div class="col-12 col-item">
                <h5 class="font-weight-600 mb-2">Upload Document</h5>
                <input type="file" id="document-upload" name="document" class="form-control" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png">
              </div>
              <div class="col-12 col-item">
                <h5 class="font-weight-600 mb-2">Category</h5>
                <select id="document-category" class="form-select">
                  <option>Select category</option>
                  <option value="Registration">Registration</option>
                  <option value="Consent">Consent</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div class="col-12 col-item">
                <h5 class="font-weight-600 mb-2">Title</h5>
                <input type="text" id="document-title" placeholder="Enter title of your document" class="form-control">
              </div>
              <div class="col-12 col-item">
                <h5 class="font-weight-600 mb-2">Description <span class="font-weight-400 text-gray" style="font-style: italic;">Optional</span></h5>
                <textarea id="document-description" class="form-control" style="min-height: 100px;"></textarea>
              </div>
            </div>
            <div class="mt-2 d-flex justify-content-end g2">
              <button id="upload-document-btn" class="btn btn-ramblers4 px-4">Upload Document</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Document Viewer Modal -->
  <div class="modal fade" id="documentViewer" tabindex="-1" aria-labelledby="documentViewerLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="documentViewerLabel">Document Viewer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe id="document-viewer-iframe" src="" width="100%" height="500px"></iframe>
        </div>
      </div>
    </div>
  </div>

  <script src="js/script.js"></script>
  <script>
  
    document.addEventListener('DOMContentLoaded', function() {
      fetchDocuments();
       // Add event listener to the "Create New" button
  document.getElementById('create-new-btn').addEventListener('click', function() {
    toggleRegistrationForm();
  });

  // Add event listener to the back button on the registration form
  document.getElementById('registration_btn').addEventListener('click', function() {
    toggleRegistrationForm(false);
  });
    });
// Function to toggle the registration form visibility
function toggleRegistrationForm(showForm = true) {
  const registrationForm = document.getElementById('registration_form');
  const documentList = document.getElementById('registration');

  if (showForm) {
    registrationForm.style.display = 'block';
    documentList.style.display = 'none';
  } else {
    registrationForm.style.display = 'none';
    documentList.style.display = 'block';
  }
}
    function fetchDocuments() {
      fetch('/api/documents', {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'organizationId': localStorage.getItem('organizationId')
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          populateDocumentList(data.documents);
        } else {
          console.error('Failed to fetch documents:', data.message);
        }
      })
      .catch(error => console.error('Error fetching documents:', error));
    }

    function populateDocumentList(documents) {
      const documentList = document.getElementById('document-list');
      documentList.innerHTML = '';

      documents.forEach(doc => {
        documentList.innerHTML += `
          <tr>
            <td>${new Date(doc.createdAt).toLocaleDateString()}</td>
            <td>${doc.category}</td>
            <td>${doc.title}</td>
            <td>${doc.status}</td>
            <td>
                 <a href="#" onclick="viewDocument('${doc._id}')">
                <img src="images/attatch.png" class="user-dp3">
              </a>
            </td>
          </tr>
        `;
      });
    }

    function viewDocument(documentId) {
  const iframe = document.getElementById('document-viewer-iframe');
  iframe.src = `/api/documents/${documentId}`;
  const documentViewerModal = new bootstrap.Modal(document.getElementById('documentViewer'));
  documentViewerModal.show();
}


    document.getElementById('upload-document-btn').addEventListener('click', function() {
      const fileInput = document.getElementById('document-upload');
      const category = document.getElementById('document-category').value;
      const title = document.getElementById('document-title').value;
      const description = document.getElementById('document-description').value;

      if (fileInput.files.length === 0) {
        alert('Please select a file to upload.');
        return;
      }

      const formData = new FormData();
      formData.append('document', fileInput.files[0]);
      formData.append('category', category);
      formData.append('title', title);
      formData.append('description', description);

      fetch('/api/documents/upload', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'organizationId': localStorage.getItem('organizationId')
        },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Document uploaded successfully.');
          fetchDocuments(); // Refresh document list
        } else {
          console.error('Failed to upload document:', data.message);
        }
      })
      .catch(error => console.error('Error uploading document:', error));
    });
  </script>
</body>
</html>
