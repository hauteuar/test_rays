<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Billing</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/mobile.css">
    <link rel="stylesheet" href="css/tab.css">
    <link rel="shortcut icon" href="images/1.png" />

    <script src="components/sidebar.js" type="text/javascript" defer></script>
    <script src="components/topnav.js" type="text/javascript" defer></script>
    <style>
        .status-indicator.fully-paid {
    background-color: #d4edda;
    color: #155724;
    padding: 5px 10px;
    border-radius: 5px;
    display: inline-block;
}
.range.green {
    background-color: #28a745;
}
.range.orange {
    background-color: #ffc107;
}
.range.red {
    background-color: #dc3545;
}
.range.white {
    background-color: #ffffff;
}

    </style>
</head>

<body>
    <div class="container-scroller">
        <div class="container-fluid page-body-wrapper">
            <sidebar-component data-page="billing"></sidebar-component>
            <topnav-component></topnav-component>
            <div class="course-main billing">
                <div class="row justify-content-between">
                    <div class="mb-3 mt-2 heading">
                        <h4 style="font-weight: 650;margin-left: 0.7rem;">Billing</h4>
                    </div>
                </div>
                <ul class="nav nav-pills side-tab-pills mt-2 main-tab" id="pills-tab" role="tablist"
                    style="width:auto;border-bottom: 1px solid #ddd;">
                    <li class="nav-item">
                        <a class="nav-link active" id="student-tab" data-toggle="pill" href="#student" role="tab"
                            aria-controls="student" aria-selected="true">Student</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="coach-tab" data-toggle="pill" href="#coach" role="tab"
                            aria-controls="coach" aria-selected="false">Coach</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="invoice-tab" data-toggle="pill" href="#invoice" role="tab"
                            aria-controls="invoice" aria-selected="false">Invoice</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="tax-tab" data-toggle="pill" href="#tax" role="tab"
                            aria-controls="tax" aria-selected="false">Tax</a>
                    </li>
                </ul>
                <div class="tab-content w-100 mt-1" id="pills-tabContent">
                    <!-- Student Tab -->
                    <div class="tab-pane fade show active" id="student" role="tabpanel" aria-labelledby="student-tab">
                        <div class="row">
                            <div class="col-4 mt-3" style="border-radius: 40px; overflow: hidden;">
                                <ul id="student-list" class="nav nav-pills side-tab-pills mt-2 inner-tab"></ul>
                            </div>
                            <div class="col-8 mt-4" style="background-color: #fff; border-radius: 8px;">
                                <div id="student-details" class="tab-content w-100 mt-1"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Coach Tab -->
                    <div class="tab-pane fade" id="coach" role="tabpanel" aria-labelledby="coach-tab">
                        <div class="row">
                            <div class="col-4 mt-3" style="border-radius: 40px; overflow: hidden;">
                                <ul id="coach-list" class="nav nav-pills side-tab-pills mt-2 inner-tab"></ul>
                            </div>
                            <div class="col-8 mt-4" style="background-color: #fff; border-radius: 8px;">
                                <div id="coach-details" class="tab-content w-100 mt-1">
                                    <p>Payout Pending</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Invoice Tab -->
                    <div class="tab-pane fade" id="invoice" role="tabpanel" aria-labelledby="invoice-tab">
                        <!-- Invoice content remains unchanged -->
                    </div>
                    <!-- Tax Tab -->
                    <div class="tab-pane fade" id="tax" role="tabpanel" aria-labelledby="tax-tab">
                        <!-- Tax content remains unchanged -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Payment Details -->
    <div class="modal fade" id="payment-details-modal" tabindex="-1" role="dialog" aria-labelledby="payment-details-modal-label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="payment-details-modal-label">Payment Details</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="payment-details-content">
                    <!-- Payment details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="components/sidebar.js" type="text/javascript" defer></script>
    <script src="components/topnav.js" type="text/javascript" defer></script>
    <script>
document.addEventListener('DOMContentLoaded', function () {
    const organizationId = localStorage.getItem('organizationId');
    const studentListElement = document.getElementById('student-list');

    // Load Students
    fetch(`/api/user/organization/${organizationId}/students`, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'organizationId': organizationId
        }
    })
    .then(response => response.json())
    .then(students => {
        Promise.all(students.map(student => loadStudentPaymentStatus(student)))
            .then(studentElements => {
                // Sort student elements by payment status
                studentElements.sort((a, b) => {
                    if (a.paymentStatus === -1) return 1; // No payments last
                    if (b.paymentStatus === -1) return -1;
                    return a.paymentStatus - b.paymentStatus; // Pending payments first
                });

                studentElements.forEach(studentElement => {
                    studentListElement.appendChild(studentElement.element);
                });
            });
    });

    function loadStudentPaymentStatus(student) {
        return fetch(`/api/payments/user/${student._id}`)
            .then(response => response.json())
            .then(payments => {
                const paymentStatus = calculatePaymentStatus(payments);
                const studentElement = createStudentElement(student, paymentStatus);
                return {
                    element: studentElement,
                    paymentStatus: paymentStatus
                };
            });
    }

    function calculatePaymentStatus(payments) {
        if (!Array.isArray(payments) || payments.length === 0) {
            return -1; // No payments found
        }

        let completedPayments = payments.filter(payment => payment.status === 'completed').length;
        let totalPayments = payments.length;
        return (completedPayments / totalPayments) * 100;
    }

    function createStudentElement(student, paymentStatus) {
        const li = document.createElement('li');
        li.className = 'nav-item';
        li.style.width = '100%';
        li.innerHTML = `
            <a class="nav-link" id="${student._id}-tab" data-toggle="pill" href="#${student._id}" role="tab" aria-controls="${student._id}" aria-selected="false" style="padding: 0;">
                <div class="student-list" style="display: flex; align-items: center;">
                    <div class="profile" style="display: flex; align-items: center;">
                        <img src="images/coach-dp.png" alt="" style="margin-right: 10px;">
                        <h4 style="margin: 0;">${student.name || 'Unnamed Student'}</h4>
                    </div>
                    ${paymentStatus === 100 ? 
                        '<div class="status-indicator fully-paid" style="margin-left: auto;">Fully paid</div>' :
                        `<input id="billing-range" type="range" min="0" max="100" value="${paymentStatus >= 0 ? paymentStatus : 0}" class="range ${getStatusClass(paymentStatus)}" disabled style="margin-left: auto; width: 50%;">`
                    }
                </div>
            </a>
        `;
        li.querySelector('a').addEventListener('click', () => loadStudentDetails(student));
        return li;
    }

    function getStatusClass(paymentStatus) {
        if (paymentStatus === -1) return 'white'; // No payments found
        if (paymentStatus >= 75) return 'green';
        if (paymentStatus >= 50) return 'orange';
        return 'red';
    }

    function loadStudentDetails(student) {
        fetch(`/api/payments/user/${student._id}`)
        .then(response => response.json())
        .then(payments => {
            const detailsContainer = document.getElementById('student-details');
            detailsContainer.innerHTML = createStudentDetails(student, payments);
        });
    }

    function createStudentDetails(student, payments) {
        let html = `
            <div class="billing-header">
                <div class="profile">
                    <img src="images/coach-dp.png" alt="">
                    <h4 class="name">${student.name}</h4>
                </div>
            </div>
            <div class="table-container">
                <table class="billing-table">
                    <thead>
                        <th>Service/Course Name</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th></th>
                    </thead>
                    <tbody>
        `;

        if (payments.length === 0) {
            html += `
                <tr>
                    <td colspan="4" style="text-align: center;">No transactions done</td>
                </tr>
            `;
        } else {
            payments.forEach(payment => {
                html += `
                    <tr>
                        <td>${payment.courseName}</td>
                        <td>$${payment.amount}</td>
                        <td>${payment.status}</td>
                        <td class="view">
                            <a href="#" data-toggle="modal" data-target="#payment-details-modal" onclick="viewPaymentDetails(${payment})">View details</a>
                        </td>
                    </tr>
                `;
            });
        }
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        return html;
    }

    window.viewPaymentDetails = function (payment) {
        const detailsContent = document.getElementById('payment-details-content');
        detailsContent.innerHTML = `
            <p><strong>Service/Course Name:</strong> ${payment.courseName}</p>
            <p><strong>Amount:</strong> $${payment.amount}</p>
            <p><strong>Status:</strong> ${payment.status}</p>
            <p><strong>Payment Date:</strong> ${payment.paymentDate}</p>
        `;
    };

    // Load Coaches
    fetch(`/api/user/organization/${organizationId}/coaches`, {
        headers: {
            'Content-Type': 'application/json',
            'organizationId': organizationId
        }
    })
    .then(response => response.json())
    .then(coaches => {
        coaches.forEach(coach => {
            const coachElement = createCoachElement(coach);
            document.getElementById('coach-list').appendChild(coachElement);
        });
    });

    function createCoachElement(coach) {
        const li = document.createElement('li');
        li.className = 'nav-item';
        li.style.width = '100%';
        li.innerHTML = `
            <a class="nav-link" id="${coach._id}-tab" data-toggle="pill" href="#${coach._id}" role="tab" aria-controls="${coach._id}" aria-selected="false" style="padding: 0;">
                <div class="coach-list">
                    <div class="profile">
                        <img src="images/coach-dp.png" alt="">
                        <h4>${coach.name}</h4>
                    </div>
                </div>
            </a>
        `;
        return li;
    }
});
    </script>
</body>

</html>

    </script>
</body>

</html>
